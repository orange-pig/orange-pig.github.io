<!doctype html><html lang=zh-CN x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>NSIS 从入门到编写完整打包脚本——2024/12/02 | 若烟阁</title><link rel=canonical href=https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/><meta name=author content="Author Name"><meta name=description content="NSIS的实战经验教程，从实际过程和知识点踩坑，循序渐进简单学会NSIS。
"><meta name=keywords content="NSIS,Installer"><meta name=generator content="Hugo 0.151.0"><meta property="og:url" content="https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/"><meta property="og:site_name" content="若烟阁"><meta property="og:title" content="NSIS 从入门到编写完整打包脚本——2024/12/02"><meta property="og:description" content="NSIS的实战经验教程，从实际过程和知识点踩坑，循序渐进简单学会NSIS。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-15T11:56:22+08:00"><meta property="article:modified_time" content="2025-10-15T11:56:22+08:00"><meta property="article:tag" content="NSIS"><meta property="article:tag" content="Installer"><meta property="og:image" content="https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/cover.png"><meta name=twitter:title content="NSIS 从入门到编写完整打包脚本——2024/12/02"><meta name=twitter:description content="NSIS的实战经验教程，从实际过程和知识点踩坑，循序渐进简单学会NSIS。"><link rel=stylesheet href=/blog/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-4EHxtjnR5rL8JzbY12OKQJr81ESm7JBEb49ORPo29AY=" crossorigin=anonymous></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav class="mt-4 lg:mt-8 py-4"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src=/blog/img/avatar.jpg alt=若烟阁></div></div><div><a href=https://orange-pig.github.io/blog/ class="text-lg font-semibold cursor-pointer">若烟阁</a><div class="text-base-content/60 text-sm">知识浩瀚若烟，或有一瓢。不欲充数泛滥，凝练真知灼见</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=关于><ion-icon name=information-circle></ion-icon>关于</div></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/blog/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/blog/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/blog/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=关于>关于</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/blog/posts title=归档><ion-icon class=group-hover:text-primary-content name=archive></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/blog/categories title=所有分类><ion-icon class=group-hover:text-primary-content name=grid></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/blog/tags title=所有标签><ion-icon class=group-hover:text-primary-content name=pricetags></ion-icon></a></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="NSIS 从入门到编写完整打包脚本——2024/12/02"><meta itemprop=description content="NSIS的实战经验教程，从实际过程和知识点踩坑，循序渐进简单学会NSIS。"><meta itemprop=datePublished content="2025-10-15T11:56:22+08:00"><meta itemprop=dateModified content="2025-10-15T11:56:22+08:00"><meta itemprop=wordCount content="2824"><meta itemprop=image content="https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/cover.png"><meta itemprop=keywords content="NSIS,Installer"><header><h1 itemprop=headline>NSIS 从入门到编写完整打包脚本——2024/12/02</h1><p class=text-sm>星期三, 10月 15, 2025
| <span>14分钟阅读</span>
| <span>更新于
星期三, 10月 15, 2025</span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>Author Name</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=NSIS%20%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%bc%96%e5%86%99%e5%ae%8c%e6%95%b4%e6%89%93%e5%8c%85%e8%84%9a%e6%9c%ac%e2%80%94%e2%80%942024/12/02&amp;url=https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=NSIS%20%e4%bb%8e%e5%85%a5%e9%97%a8%e5%88%b0%e7%bc%96%e5%86%99%e5%ae%8c%e6%95%b4%e6%89%93%e5%8c%85%e8%84%9a%e6%9c%ac%e2%80%94%e2%80%942024/12/02%20https://orange-pig.github.io/blog/posts/coding/nsis-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><p>NSIS的实战经验教程，从实际过程和知识点踩坑，循序渐进简单学会NSIS。</p><p>NSIS是功能强大的安装包制作工具，但其高质量的教程稀少，大部分文章浅尝辄止，导致新手上手困难很难写出实际使用的安装包。且官方文档只罗列知识点，让人很难组合成实际用途。作者认为比起手册式写法，更需要从实际使用的角度出发的文章，在过程中逐渐引入概念和用法，更加符合人学习的思维。</p><hr><h1 id=1-开始使用>1. 开始使用</h1><h3 id=11-简介>1.1 简介</h3><p><em>来自官方的介绍：</em></p><blockquote><p>NSIS (Nullsoft Scriptable Install System) 是 Windows 下的一个安装程序创建工具，它允许程序员来创建这样的安装程序。</p><p>NSIS 创建的安装程序能够安装、卸载、设置系统设置、解压文件等等。 因为它基于脚本文件，你可以完全的控制安装程序的每一部分。 脚本语言支持变量、函数、字串操作，就像一个普通的程序语言一样 - 但是设计来创建安装程序。 即使有那么多的特性， NSIS 仍然是最小的安装程序系统。在默认选项下，它仅增加了 34 KB 的开销。</p></blockquote><h3 id=12-nsis常用特性>1.2 NSIS常用特性</h3><ul><li>脚本化，支持多文件的代码组织</li><li>注册表编辑、执行脚本、修改环境变量</li><li>较小的安装压缩大小</li><li>较为美观的界面，还支持自定义界面</li><li>插件系统</li><li>支持网络安装</li><li>支持做补丁安装</li></ul><h3 id=13-安装>1.3 安装</h3><p>在<a href=https://nsis.sourceforge.io/Download target=_blank>官网下载</a>
NSIS安装包。安装后将安装路径加入系统环境变量，如：C:\Program Files (x86)\NSIS。在命令行中输入<code>nsis</code>或<code>makensis</code>测试是否工作。</p><h3 id=14-脚本示例项目>1.4 脚本示例项目</h3><p>本文同时提供有一个<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
，它包含在文档中内容的代码示例，包括几个示例项目，可以对照脚本与文章内容，会更容易理解到如何使用NSIS。</p><p>项目对应关系如下表：</p><table><thead><tr><th>项目</th><th>主文件</th><th>介绍</th></tr></thead><tbody><tr><td>base/</td><td>base/installer.nsi</td><td>包含安装脚本的主体结构，与本文章节3对应</td></tr><tr><td>install/</td><td>install/installer.nsi</td><td>在base的基础上增加安装与卸载的内容，与本文的章节4、5、6对应</td></tr></tbody></table><h1 id=2-开始编写一个脚本>2. 开始编写一个脚本</h1><p>NSIS 可以通过多种方式编写：图形化Editor、脚本、三方工具。中文互联网上很多博客都是关于图形化Editor的，实际上这个东西做出来自己用用还行，距离商业化还是有些距离。本文是以编写脚本代码的方式来定义安装包的，原理如下：</p><p><img src=./image/2-1.webp alt></p><p><strong>创建代码文件</strong></p><p>NSIS脚本文件的拓展名是.nsi，我们创建一个 installer.nsi，文件名可以随意取。一般为要打包的程序名称，本文示例为了不产生误解取为 installer。</p><p>.nsi文件可以使用任何文本编辑器打开，建议使用vscode打开，安装NSIS的vscode插件编写更加方便。</p><p><strong>在文件中添加一个安装区段</strong></p><p><code>installer.nsi</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#e6db74>&#34;Section1&#34;</span> SEC01
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>这里引入一个<code>区段</code>的概念，区段内包含安装或卸载过程的逻辑，用于组织不同的安装内容，有以下重要特点：</p><ul><li><strong>必须至少有一个区段，不然程序没有安装的内容</strong></li><li>区段默认为安装区段，un.开头的区段为卸载区段，</li><li>区段可不设置区段名，或者在名称前加短横线<code>-</code>，这样让其在安装过程中不可见，悄悄安装</li><li>区段可以是一个空区段</li></ul><p>区段由Section和SectionEnd组成，Section行中参数依次为：区段名、区段的唯一标识码（不是必须，可以不设置）。代码中<code>Section1</code>为区段名，<code>SEC01</code>为区段的唯一标识码，用于其他地方操作区段的标识使用。<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#sections target=_blank>官方文档</a></p><p><strong>添加输出文件和安装代码</strong></p><p><code>installer.nsi</code></p><p>有了安装区段后，还必须设置一个输出文件，告诉NSIS编译器安装包的输出位置。在installer.nsi的开头加入下面这行代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>OutFile</span> <span style=color:#e6db74>&#34;MyApp_Setup.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#e6db74>&#34;Section1&#34;</span> SEC01
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;..\myapp\MyApp.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>这里使用了一个属性命令<code>OutFile</code>，它是必须有的命令。指定生成的安装包的路径和名称，可以设置相对路径与绝对路径。当只有名称时，生成文件与.nsi文件同目录。</p><p><code>OutFile</code> 是<strong>必须的</strong>命令，指定编译器输出安装包的路径。使用方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>OutFile</span> <span style=color:#960050;background-color:#1e0010>[</span>路径<span style=color:#960050;background-color:#1e0010>]</span>安装程序名称.exe
</span></span><span style=display:flex><span><span style=color:#75715e># eg.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OutFile</span> <span style=color:#e6db74>&#34;MyApp.exe&#34;</span> <span style=color:#75715e>;只指定程序名称的情况下，安装文件输出到.nsi脚本同目录下</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OutFile</span> <span style=color:#e6db74>&#34;D:\installer\MyApp.exe&#34;</span> <span style=color:#75715e>;指导路径的情况下，输出到指定路径下</span>
</span></span></code></pre></div><blockquote><p>💡Tip1: 这里用到了命令，命令分为<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#instattribs target=_blank>安装程序属性命令</a>
和<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#flags target=_blank>编译器命令</a></p><p>💡Tip2: 这里用到了<code>;</code>，它和<code>#</code>一起在NSIS的脚本中作为注释符，后跟注释内容</p></blockquote><p>安装程序属性命令用于指定安装包相关的属性值，编译器命令用于指定编译器在编译时的选项。</p><p>Section中使用了两个<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#instr target=_blank>指令</a>
<code>SetOutPath</code>和<code>File</code>，前者用于指定后续指令的输出目录，后者用于指定安装包在打包时要包含进那些文件，且在安装时要将这些文件安装到前者指定的目录中去。</p><blockquote><p>💡Tip: 这里用到的两个指令都是<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#basicinstructions target=_blank>基础指令</a>
，指令还有很多种类型，它们都需要包含在区段或函数中才能运行。与<strong>命令</strong>的区别是，命令都在编译安装包时运行，指令在安装或卸载时运行。</p><p>👀 这里有一个情况需要注意，在官方文档或者一些论坛博客内，往往可能会混用<strong>命令</strong>与<strong>指令</strong>的概念。可以这样理解，命令分为编译时的命令和运行时的命令，前者在制作安装包时执行（由NSIS编译器执行），后者称之为<strong>指令</strong>在安装包运行时执行（由一个负责脚本解析的虚拟机执行）。</p></blockquote><p>🌟<strong>知识点</strong>🌟</p><p>SetOutPath 使用了一个值 <a href=https://www.nsisfans.com/help/Section4.2.html#4.2.2 target=_blank>$INSTDIR</a>
，这是一个已经被声明的变量。变量用来临时存储一些值，它可以被改变，在变量名前面加上 <code>$</code> 符号使用，自定义的变量要自己声明。查看文档<a href=https://www.nsisfans.com/help/Section4.2.html target=_blank>变量</a>
了解更多。</p><blockquote><p>💡Tip: 这里有个注意点，$INSTDIR 前后用引号包起来了。这是因为在NSIS里，数值和字符串用法都是一样。区别的方式就是字符串值在使用时，用引号包起来，不然默认会被当成数值处理。</p></blockquote><p><strong>执行脚本编译安装包</strong></p><p>这样就完成了一个最简单的脚本文件，在命令行中执行：</p><blockquote><p>makensis ./installer.nsi</p></blockquote><blockquote><p>注：如果提示没有找到 makensis，那你可能是没有设置nsis的环境变量</p></blockquote><h1 id=3-完善安装包主要结构>3. 完善安装包主要结构</h1><p>本章代码在<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
中对应<code>base</code>项目的installer.nsi，可以将本章内容与代码对照，会更容易理解到如何使用NSIS。</p><h3 id=31-安装程序属性>3.1 安装程序属性</h3><p>安装程序属性主要控制安装程序的：程序信息、图标、默认安装目录、外观、安装界面文本、页面、包含的文件。</p><p>这里主要介绍常用到的属性（如下例），更多的属性设置在<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#attribgen target=_blank>官方文档</a>
中可以查到。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># define const value</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_NAME <span style=color:#e6db74>&#34;My app&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_SHORT_NAME <span style=color:#e6db74>&#34;MyApp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_VERSION <span style=color:#e6db74>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_BUILD_VERSION <span style=color:#e6db74>&#34;1.0.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_PUBLISHER <span style=color:#e6db74>&#34;My company, Inc.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_COPYRIGHT <span style=color:#e6db74>&#34;Copyright (c) 2023 My company Inc.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_WEB_SITE <span style=color:#e6db74>&#34;http://www.mycompany.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># info of installer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Name</span> <span style=color:#e6db74>&#34;${PRODUCT_NAME} ${PRODUCT_VERSION}&#34;</span> <span style=color:#75715e>; set name of installer execute</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OutFile</span> <span style=color:#e6db74>&#34;MyApp_Setup.exe&#34;</span> <span style=color:#75715e>; set file name of compiler out</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Icon</span> <span style=color:#e6db74>&#34;..\myapp\nsis.ico&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>InstallDir</span> <span style=color:#e6db74>&#34;C:${PRODUCT_SHORT_NAME}&#34;</span> <span style=color:#75715e>; set the default install dir</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># info of installer execute file</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> ProductName <span style=color:#e6db74>&#34;${PRODUCT_NAME} Installer&#34;</span> <span style=color:#75715e>; product name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> ProductVersion <span style=color:#e6db74>&#34;${PRODUCT_VERSION}&#34;</span> <span style=color:#75715e>; product version</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> Comments <span style=color:#e6db74>&#34;${PRODUCT_NAME}&#34;</span> <span style=color:#75715e>; description</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> CompanyName <span style=color:#e6db74>&#34;${PRODUCT_PUBLISHER}&#34;</span> <span style=color:#75715e>; compnay name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> LegalCopyright <span style=color:#e6db74>&#34;${PRODUCT_COPYRIGHT}&#34;</span> <span style=color:#75715e>; copyright</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> FileVersion <span style=color:#e6db74>&#34;${PRODUCT_BUILD_VERSION}&#34;</span> <span style=color:#75715e>; file version</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIAddVersionKey</span> FileDescription <span style=color:#e6db74>&#34;${PRODUCT_NAME} Installer&#34;</span> <span style=color:#75715e>; file description</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>VIProductVersion</span> <span style=color:#e6db74>&#34;${PRODUCT_BUILD_VERSION}&#34;</span> <span style=color:#75715e>; product verion(actual replace FileVersion)</span>
</span></span></code></pre></div><p>常用的设置安装属性的命令都是编辑时命令，更多属性和特殊用法查看<a href=https://www.nsisfans.com/help/Section4.8.html target=_blank>安装程序属性</a>
：</p><p>🌟<strong>基础语法</strong>🌟</p><p><code>!define</code>是定义常量值的命令，它是一个编译时命令。常量定义好后不能改变值，定义后的常量使用 <code>${常量名}</code>进行使用。如示例代码中的：${PRODUCT_NAME}</p><p><strong>添加安装程序信息</strong></p><p><code>Name</code> 设置安装程序的名称。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Name</span> <span style=color:#e6db74>&#34;My Application&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Name</span> <span style=color:#e6db74>&#34;Jhon &amp; Jack App&#34;</span> <span style=color:#e6db74>&#34;Jhon &amp;&amp; Jack App&#34;</span>
</span></span></code></pre></div><p>注意：当名称中使用了<code>&</code>符号时，就需要传入第二个参数“双&名称”，将第一个参数名称中的&用两个&表示。</p><p><code>Icon</code> 设置安装程序的图标，图标文件后缀名为.ico。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Icon</span> <span style=color:#960050;background-color:#1e0010>[</span>图标文件路径<span style=color:#960050;background-color:#1e0010>]</span>
</span></span></code></pre></div><p><code>InstallDir</code> 设置默认安装目录。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>InstallDir</span> <span style=color:#960050;background-color:#1e0010>[</span>路径<span style=color:#960050;background-color:#1e0010>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># eg:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>InstallDir</span> <span style=color:#e6db74>&#34;</span>$PROGRAMFILES<span style=color:#e6db74>\YourApp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>InstallDir</span> <span style=color:#e6db74>&#34;C:\YourApp&#34;</span>
</span></span></code></pre></div><blockquote><p>💡Tip: <strong>$PROGRAMFILES</strong> 是一个NSIS定义的变量的常量，说是常量其实就是NSIS的提供的系统环境变量，用于获取各种路径。使用方式与变量相同，查看<a href=https://www.nsisfans.com/help/Section4.2.html#4.2.3 target=_blank>变量的常量</a>
章节了解可以使用的值。</p></blockquote><p><strong>安装程序版本信息类</strong></p><p><code>VIAddVersionKey</code>与<code>VIProductVersion</code>共同决定安装程序的版本信息，前方示例代码设置的属性在文件信息上看就是这样了。<a href=https://nsis.sourceforge.io/Docs/Chapter4.html#versioninfo target=_blank>官方文档</a></p><p><img src=./image/3-1.webp alt></p><h3 id=32-添加安装界面>3.2 添加安装界面</h3><p>大部分的安装包都是有着完善的安装过程，它往往由几个界面组成：</p><ul><li>欢迎界面</li><li>license界面</li><li>安装路径选择界面</li><li>安装过程界面</li><li>安装完成界面</li></ul><h4 id=321-古典过气安装界面>3.2.1 古典（过气）安装界面</h4><p>由于古典界面过于的古典，所以简单介绍一下，应该基本不会在当代的主流安装UI中被需要。</p><p>使用<code>Page</code>命令指定安装过程要包含的界面，<code>UninstPage</code>命令指定卸载过程界面，通过调整前后顺序来排列安装界面的顺序。<a href=https://www.nsisfans.com/help/Section4.5.html#4.5 target=_blank>中文文档</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># 安装界面</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Page</span> license
</span></span><span style=display:flex><span><span style=color:#66d9ef>Page</span> components
</span></span><span style=display:flex><span><span style=color:#66d9ef>Page</span> directory
</span></span><span style=display:flex><span><span style=color:#66d9ef>Page</span> instfiles
</span></span><span style=display:flex><span><span style=color:#75715e># 卸载界面</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>UninstPage</span> uninstConfirm
</span></span><span style=display:flex><span><span style=color:#66d9ef>UninstPage</span> instfiles
</span></span></code></pre></div><p>古典安装界面风格：</p><p><img src=./image/3-2.webp alt>
<img src=./image/3-3.webp alt>
<img src=./image/3-4.webp alt>
<img src=./image/3-5.webp alt></p><h4 id=322-现代ui界面mui>3.2.2 现代UI界面（MUI）</h4><p>现代UI简称为MUI，是NSIS安装包最流行的UI库，<a href=https://nsis.sourceforge.io/Docs/Modern%20UI%202/Readme.html target=_blank>文档链接</a></p><blockquote><p>💡💁🗒️Tips: 后续文档中的UI不做特别说明，默认为MUI。</p></blockquote><p>NSIS自带MUI，所以直接引用进来：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!include</span> <span style=color:#e6db74>&#34;MUI.nsh&#34;</span>
</span></span></code></pre></div><p>先进行基础设置，<code>MUI_ABORTWARNING</code>常量标志关闭安装程序窗口时给出警告提示，<code>MUI_ICON</code>常量是MUI安装程序和界面的logo图标，在作用上替代了前文中Icon 命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_ABORTWARNING
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_ICON <span style=color:#e6db74>&#34;..\myapp\nsis.ico&#34;</span>
</span></span></code></pre></div><p>再设置MUI的界面，使用 <code>insertmacro</code>关键字导入不同界面的宏定义。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Welcome page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_WELCOME
</span></span><span style=display:flex><span><span style=color:#75715e>; License page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_LICENSE <span style=color:#e6db74>&#34;.\myapp\license.txt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; Components page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_COMPONENTS
</span></span><span style=display:flex><span><span style=color:#75715e>; Directory page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_DIRECTORY
</span></span><span style=display:flex><span><span style=color:#75715e>; Instfiles page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_INSTFILES
</span></span><span style=display:flex><span><span style=color:#75715e>; Finish page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_FINISH
</span></span></code></pre></div><p>这里用到了<code>insertmarco</code>关键字和<code>macro(宏)</code>的概念，宏常用于组织安装与卸载的代码片段。</p><blockquote><p>🌟Tips: 与区段不同的是，宏用于将可重复使用的脚本片段，在各个需要的地方用<code>!insetmarco</code>标记插入位置。宏命令是在编译时插入代码，这样你只需要写一份通用的代码，就可以多处的使用。</p></blockquote><p>MUI的界面风格如下：</p><p><img src=./image/3-6.webp alt>
<img src=./image/3-7.webp alt>
<img src=./image/3-8.webp alt>
<img src=./image/3-9.webp alt>
<img src=./image/3-10.webp alt></p><p>这样安装界面就定义完成了，可以根据自己的喜好删减和排列不同的界面。</p><p>但请注意，如果只有安装界面并不能成功编译出安装包，我们还需要定义卸载程序。</p><h3 id=33-卸载程序属性>3.3 卸载程序属性</h3><p>有安装程序，那么与之对应的就是卸载程序。卸载程序对应着我们的程序的卸载过程，对于常规软件来说，必提供卸载程序给用户方便卸载。</p><blockquote><p>🌟Tips: 卸载属性必须在所有安装和卸载页面之前定义。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># uninstaller</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_UNICON <span style=color:#e6db74>&#34;..\myapp\uninstall.ico&#34;</span>
</span></span></code></pre></div><p><code>MUI_UNICON</code>常量指定卸载程序使用的图标。</p><h3 id=34-卸载程序>3.4 卸载程序</h3><p>不同于安装程序，卸载程序包含在安装程序内被一起安装，在安装后运行进行卸载，所以NSIS要求我们在安装的Section中定义卸载程序，由编译器生成。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#e6db74>&#34;Section1&#34;</span> SEC01
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteUninstaller</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\uninstall.exe&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;..\myapp\MyApp.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>并且，需要至少编写一个卸载区段，作为卸载程序的执行内容。这里使用唯一特殊的卸载区段<code>Uninstall</code>，这是一个特殊的卸载区段名称，可以不用加<code>un.</code>的前缀。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>Uninstall
</span></span><span style=display:flex><span>  <span style=color:#75715e>; your uninstall code here</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><h3 id=35-添加卸载界面>3.5 添加卸载界面</h3><p>与安装界面同理，我们给卸载程序加入&lt;组件卸载界面>和&lt;卸载安装文件>界面。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Uninstaller pages</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNPAGE_COMPONENTS
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNPAGE_INSTFILES
</span></span></code></pre></div><h3 id=36-设置界面语言>3.6 设置界面语言</h3><p>最后设置界面使用的语言，🚨需要注意的是，语言设置必须放在所有安装和卸载界面之后，不然编译会出现一个<a href=https://nsis-dev.github.io/NSIS-Forums/html/t-278169.html target=_blank>错误</a>
，或别的未知错误。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Language files</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_LANGUAGE <span style=color:#e6db74>&#34;English&#34;</span>
</span></span></code></pre></div><blockquote><p>🌟Tips: 这里涉及到一个代码顺序的问题，NSIS是顺序执行的，所以代码顺序十分重要。因为MUI在使用中包含宏代码，而它的宏代码中的变量又有前后关系，所以使用MUI的过程中会经常遇到一些因为代码顺序导致的问题。</p></blockquote><h1 id=4-编写安装与卸载内容>4. 编写安装与卸载内容</h1><p>在安装程序中，安装与卸载是伴生关系，一般编写了什么安装内容，就需要编写与之相应的卸载内容。</p><p>本章代码在<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
中对应<code>install</code>项目的installer.nsi，可以将本章内容与代码对照，更直观的理解如何编写安装与卸载内容。</p><blockquote><p>👀 注意：文章和示例项目中提供的代码示例都以一个软件中一个可执行程序为例，实际项目中这方面没有任何限制。一个软件中可以包含任意多个各类可执行的文件如：.exe，.cmd，.bat 等等。你都可以为他们创建桌面和开始菜单的快捷方式，在安装过程中和完成后运行等可行的所有操作。</p></blockquote><h3 id=41-安装和卸载文件>4.1 安装和卸载文件</h3><p>从这里开始，我们将前文中<code>Section1</code>中的安装内容移动到Section<code>myapp</code>中进行默认安装。与特定的卸载Section名称<code>Uninstall</code>不同的是，安装Section并没有特定的Section名称，一般我们将程序默认安装内容的Section命名为程序的名称(如: myapp)或者<code>Post</code>，也可以按自己意愿命名。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>myapp
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteUninstaller</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\uninstall.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;..\myapp\MyApp.exe&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;/oname=$INSTDIR\repair.file&#34;</span> <span style=color:#e6db74>&#34;..\myapp\s_win_repair.file&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\bin&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;..\myapp\bin*.*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\resources&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;/oname=uninstallerIcon.ico&#34;</span> <span style=color:#e6db74>&#34;${MUI_ICON}&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>Uninstall
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\uninstall.exe&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\repair.file&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\MyApp.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\bin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\resources\uninstallerIcon.ico&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\resources&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>我们在安装时增加了<code>SetOverwrite</code>命令(<a href=https://www.nsisfans.com/help/Section4.8.html#4.8.2.8 target=_blank>文档</a>
)，这是一个<strong>编译器标记</strong>命令，它指示编译器后续代码中File指令的覆盖方式（如果存在），ifnewer 值表示当文件更新时覆盖安装。</p><blockquote><p>🌟Tips: NSIS中常常会用用到一些标记类的命令，他们经常需要在后续代码需要什么标记时进行设置，可以在多处设置不同的值。有成对的出现的情况，在设定非常规标记值后，在代码块后再将其设置回来，可以根据需要灵活搭配。</p></blockquote><p>安装中包含了<code>File</code>的常见的几种用法：</p><table><thead><tr><th><em><strong>用法</strong></em></th><th><em><strong>解析</strong></em></th></tr></thead><tbody><tr><td>File &ldquo;文件路径&rdquo;</td><td>安装指定文件到当前 SetOutPath 指定的目录下</td></tr><tr><td>File &ldquo;/onam=安装全路径&rdquo; &ldquo;文件路径&rdquo;</td><td>安装指定文件到指定路径下，并重命名文件</td></tr><tr><td>File &ldquo;/onam=文件名&rdquo; &ldquo;文件路径&rdquo;</td><td>安装指定文件到当前 SetOutPath 指定的目录下，并重命名文件</td></tr><tr><td>File /r &ldquo;文件夹和通配符&rdquo;</td><td>递归安装指定文件夹内所有的文件到当前 SetOutPath 指定的目录下，会保持内部的文件夹层级结构</td></tr></tbody></table><p>注意：<code>File</code>指令中的文件路径可以是绝对路径、相对路径或者文件名。安装位置的的相对路径和文件名相对于当前<code>SetOutPath</code>指定的目录，需要安装文件的相对路径和文件名相对于当前执行脚本的目录。更多详实信息查看<a href=https://www.nsisfans.com/help/Section4.9.html#4.9.1.5 target=_blank>文档</a></p><p>与安装相对应的的卸载过程，在无特殊需求的情况下，卸载则需要将安装的文件卸载干净，Section<code>Uninstall</code>中包含了卸载时常用的指令：</p><table><thead><tr><th><em><strong>用法</strong></em></th><th><em><strong>解析</strong></em></th></tr></thead><tbody><tr><td>Delete &ldquo;绝对文件路径&rdquo;</td><td>删除指定路径的文件</td></tr><tr><td>RMDir &ldquo;绝对文件夹路径&rdquo;</td><td>删除指定文件夹，必须为空文件夹，不然无法删除并设置错误标记（不影响流程）</td></tr><tr><td>RMDir /r &ldquo;绝对文件夹路径&rdquo;</td><td>递归删除指定文件夹</td></tr></tbody></table><p>一般的做法是，与安装的顺序对应，依次删除安装的文件，最后删除整个安装目录。</p><h3 id=42-程序快捷方式>4.2 程序快捷方式</h3><p>绝大部分的安装程序都会往桌面和开始菜单中生成安装程序的图标，这是我们的程序安装后便于使用的重要形式。</p><p><strong>安装桌面快捷方式</strong></p><p>我们先往Section myapp尾部中加入下列代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>CreateShortCut</span> <span style=color:#e6db74>&#34;</span>$DESKTOP<span style=color:#e6db74>${PRODUCT_NAME}.lnk&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>${PRODUCT_SHORT_NAME}.exe&#34;</span>
</span></span></code></pre></div><p>使用<code>CreateShortCut</code>指令创建前面使用<code>File</code>指令安装的可执行程序的快捷方式到桌面上。</p><ul><li><a href=https://www.nsisfans.com/help/Section4.2.html#4.2.3 target=_blank>$DESKTOP</a>
常量表示执行安装的计算机的系统桌面路径，虽然官方文档里叫它常量，但是实际上从用法可以看出来它是个变量🤣</li><li>${PRODUCT_NAME} 常量表示前面用户自定义的产品名</li><li>${PRODUCT_SHORT_NAME} 常量表示前面用户自定义的产品短名称</li></ul><p>CreateShortCut 生成的桌面图标默认采用指向的可执行程序的图标。如果之前生成过同名快捷方式，而图标不同，那么生成的新桌面快捷方式图标可能不会更新，需要刷新一下桌面或者注销用户重新登录才可以。</p><p><strong>安装开始菜单快捷方式</strong></p><p>再往Section myapp尾部中加入下列代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>IfFileExists</span> <span style=color:#e6db74>&#34;</span>$SMPROGRAMS<span style=color:#e6db74>${PRODUCT_NAME}&#34;</span> <span style=color:#f92672>+</span>2 0
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>CreateDirectory</span> <span style=color:#e6db74>&#34;</span>$SMPROGRAMS<span style=color:#e6db74>${PRODUCT_NAME}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CreateShortCut</span> <span style=color:#e6db74>&#34;</span>$SMPROGRAMS<span style=color:#e6db74>${PRODUCT_NAME}${PRODUCT_NAME}.lnk&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>${PRODUCT_SHORT_NAME}.exe&#34;</span>
</span></span></code></pre></div><p>同理，创建开始菜单快捷方式也是使用<code>CreateShortCut</code>在系统的指定目录下创建可执行程序的快捷方式。</p><p>这里我们在<code>$SMPROGRAMS</code>常量表示的开始菜单目录下使用<code>CreateDirectory</code>创建了产品名称的目录，再在其中创建快捷方式。</p><blockquote><p>这种在开始菜单中创建产品目录，然后再在其中放置快捷方式的方式是常规做法。也可以直接将快捷方式直接创建在开始菜单根目录中，这里自由度很高，可以根据需要自行选择。</p></blockquote><p>🌟<strong>知识点</strong>🌟</p><p>这里通过<code>IfFileExists</code>指令来判断路径是否已经存在，它是一个<strong>流程控制指令</strong>，用法是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>IfFileExists</span> 要检测的文件或路径 文件或路径存在时跳转的位置 <span style=color:#960050;background-color:#1e0010>[</span>文件或路径不存在时跳转的位置<span style=color:#960050;background-color:#1e0010>]</span>
</span></span></code></pre></div><p>位置可以指定行偏移或者标记，<strong>行偏移</strong>使用 <code>+</code>/<code>-</code>数值或者0，正数值代表从本行起向后的第几行，负数值代表从本行起向前的第几行，0代表从本行起继续执行。</p><p>如下例判断记事本程序是否已经安装在操作系统目录下，存在从改行顺序执行弹出 MessageBox。不存在则向后记2行开始执行，跳过MessageBox。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>IfFileExists</span> $WINDIR\notepad.exe 0 <span style=color:#f92672>+</span>2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>MessageBox</span> <span style=color:#66d9ef>MB_OK</span> <span style=color:#e6db74>&#34;记事本已安装&#34;</span>
</span></span></code></pre></div><p>指定<strong>标记</strong>则使用标记名称，直接跳转到标记的代码行开始执行，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>IfFileExists</span> $WINDIR\notepad.exe 0 notExists
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>MessageBox</span> <span style=color:#66d9ef>MB_OK</span> <span style=color:#e6db74>&#34;记事本已安装&#34;</span>
</span></span><span style=display:flex><span>notExists:
</span></span></code></pre></div><blockquote><p>Tips: 这样的判断指令跳转的方式在NSIS还有一些，他们都是同样的使用方式，效果与Goto一致。</p></blockquote><p><strong>卸载快捷方式</strong></p><p>与安装文件同理，安装了快捷方式后同时也要编写卸载过程。使用Delete与RMDir指令删除桌面和开始菜单中的快捷方式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; delete Desktop icon</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$DESKTOP<span style=color:#e6db74>${PRODUCT_NAME}.lnk&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; delete start menu folder </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$SMPROGRAMS<span style=color:#e6db74>${PRODUCT_NAME}${PRODUCT_NAME}.lnk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RMDir</span> <span style=color:#e6db74>&#34;</span>$SMPROGRAMS<span style=color:#e6db74>${PRODUCT_NAME}&#34;</span>
</span></span></code></pre></div><h3 id=43-注册安装程序>4.3 注册安装程序</h3><p>在Windows中，正规的软件在安装后，都可以在win7的控制面板或者win10的安装的应用内找到，供用户很方便的可以查看安装信息和卸载。</p><p>但，这并不是Windows自动检测到安装并记录的，而是一个君子协定，需要安装程序自觉进行注册后才能在已安装的列表内找到。（如果你不注册也没人来打你😜</p><p>代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> PRODUCT_UNINSTALL_KEY <span style=color:#e6db74>&#34;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall${PRODUCT_NAME}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>myapp
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>//</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Register the installed software</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;DisplayName&#34;</span> <span style=color:#e6db74>&#34;$(^Name)&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstallDir&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;UninstallString&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\uninstall.exe&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;DisplayIcon&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\resources\uninstallerIcon.ico&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;DisplayVersion&#34;</span> <span style=color:#e6db74>&#34;${PRODUCT_VERSION}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;URLInfoAbout&#34;</span> <span style=color:#e6db74>&#34;${PRODUCT_WEB_SITE}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegStr</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;Publisher&#34;</span> <span style=color:#e6db74>&#34;${PRODUCT_PUBLISHER}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><blockquote><p>💡Tips: $(^Name) 用于获取<code>Name</code>命令设定的值</p></blockquote><p>这里使用指令<code>WriteRegStr</code>添加注册表字符串值，它是一个注册表指令。基础语法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>WriteRegStr</span> rootkey subkey key_name value
</span></span><span style=display:flex><span><span style=color:#75715e># eg.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WriteRegStr</span> rootkey <span style=color:#e6db74>&#34;SOFTWARE\example&#34;</span> <span style=color:#e6db74>&#34;key1&#34;</span> <span style=color:#e6db74>&#34;Hello World!&#34;</span>
</span></span></code></pre></div><p>💡 注册表的<code>rootkey</code>可以为下列内容，他们分别记录着windows中的不同内容，常用HKLM为本机内容（一般用来记录为所有用户的信息），HKCU为当前用户。</p><ul><li><em>HKCR</em> 或 <em>HKEY_CLASSES_ROOT，前者为缩写，下同。</em></li><li><em>HKLM</em> 或 <em>HKEY_LOCAL_MACHINE</em></li><li><em>HKCU</em> 或 <em>HKEY_CURRENT_USER</em></li><li><em>HKU</em> 或 <em>HKEY_USERS</em></li><li><em>HKCC</em> 或 <em>HKEY_CURRENT_CONFIG</em></li><li><em>HKDD</em> 或 <em>HKEY_DYN_DATA</em></li><li><em>HKPD</em> 或 <em>HKEY_PERFORMANCE_DATA</em></li><li><em>SHCTX</em> 或 <em>SHELL_CONTEXT</em></li></ul><p>💡<code>subkey</code>为具体注册表项相对于rootkey的全路径，下图中的路径框中的 <strong>SOFTWARE\BiliBili</strong> 就是subkey。</p><p><img src=./image/4-1.webp alt></p><blockquote><p>🌟Tips: 如果子项并不存在，WriteRegStr 会将其创建。</p></blockquote><p>在 SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall{程序名} 这个注册表项下创建指定的 <code>DisplayName</code>、<code>InstallDir</code>、<code>UninstallString</code>、<code>DisplayIcon</code>、<code>DisplayVersion</code>、<code>URLInfoAbout</code>、<code>Publisher</code>这些值告诉Windows我们安装的程序信息。</p><blockquote><p>🌟 由于 windows 在注册表内区分了32位和64位，默认的所有路径都是32位的，64位是后面加的。所以，在64位电脑上，安装实际设置的注册表路径应该为：SOFTWARE**WOW6432Node**\Microsoft\Windows\CurrentVersion\Uninstall{程序名}</p></blockquote><p>然后，我们就可以在安装的程序列表内看到已安装的程序信息。</p><p><img src=./image/4-2.webp alt></p><p>类似的添加注册表值的指令还有：WriteINIStr、WriteRegBin、WriteRegDWORD、WriteRegExpandStr。更多注册表操作可以参考<a href=https://www.nsisfans.com/help/Section4.9.html#4.9.2 target=_blank>文档</a>
。</p><p>与其他安装过程同理，安装写入了注册表，那么就需要在卸载的时候清理干净。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>Uninstall
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>//</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; delete reg item</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>DeleteRegKey</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><h3 id=44-卸载完成自动关闭>4.4 卸载完成自动关闭</h3><p>受国产软件的荼毒，很多人不喜欢卸载完成之后还要点击完成，总觉得会被装上莫名其妙的软件。如果你也不喜欢这样，那么请在卸载的内容里设置卸载完成自动关闭。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>Uninstall
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>//</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; close after finish</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetAutoClose</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><h1 id=5-定制安装向导>5. 定制安装向导</h1><p>本章代码在<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
中对应<code>install</code>项目的installer.nsi。</p><h3 id=51-基础界面>5.1 基础界面</h3><p>NSIS提供了一系列的命令用来设置基础界面信息，以下列举最常用的，更多的见<a href=https://www.nsisfans.com/help/Section4.8.html#4.8.1 target=_blank>文档</a>
。</p><p><strong>窗口标题</strong></p><p><code>Caption</code>自定义安装程序的窗口标题。安装程序标题默认为 <code>{Name命令指定的名称} Setup</code>，如果你不喜欢可以自己设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># base ui info</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Caption</span> <span style=color:#e6db74>&#34;${PRODUCT_NAME} Installer&#34;</span>
</span></span></code></pre></div><p><strong>底部分割线文本</strong></p><p><code>BrandingText</code>设置安装窗口内容底部分割线上的文本。如果设置空字符串("")，则显示下图中默认值；如果不想在这里显示文本，设置只有一个空格的字符串<code>" "</code>就行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>BrandingText</span> <span style=color:#a6e22e>/TRIMLEFT</span> <span style=color:#e6db74>&#34;文本内容&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># eg.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BrandingText</span> <span style=color:#a6e22e>/TRIMLEFT</span> <span style=color:#e6db74>&#34;${PRODUCT_NAME} ${PRODUCT_VERSION}&#34;</span>
</span></span></code></pre></div><p><img src=./image/5-1.webp alt></p><p><strong>退出警告</strong></p><p>如果你需要在用户点击关闭按钮退出安装程序时进行提示，那么就加入下面这行代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_ABORTWARNING
</span></span></code></pre></div><p>弹出提示窗：</p><p><img src=./image/5-2.webp alt></p><p><strong>顶部右侧图标</strong></p><p>安装过程界面的顶部右侧可以设置图标，默认为NSIS的logo。我们自己程序的安装包肯定是是替换它的，通过定义下列常量来实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_HEADERIMAGE <span style=color:#75715e>; Defining this value is the basis for the follow two definitions</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_HEADERIMAGE_BITMAP <span style=color:#e6db74>&#34;.\resource\header_150x57.bmp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_HEADERIMAGE_BITMAP_STRETCH NoStretchNoCropNoAlign
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_HEADERIMAGE_RIGHT <span style=color:#75715e>; Display to right</span>
</span></span></code></pre></div><ul><li><code>MUI_HEADERIMAGE</code>作为开关量，必须定义后后续的常量才会生效</li><li><code>MUI_HEADERIMAGE_BITMAP</code>常量定义使用的图片，格式限定为(.bmp)，图片区域尺寸是150<em>57，图片最好是150</em>57的倍数，不然就会被拉伸变形。</li><li><code>MUI_HEADERIMAGE_RIGHT</code>常量定义图片显示为右侧</li></ul><p>效果图如下：</p><p><img src=./image/5-3.webp alt></p><h3 id=52-欢迎界面>5.2 欢迎界面</h3><p>定义<code>MUI_WELCOMEFINISHPAGE_BITMAP</code>常量的值为图片路径，格式限定为(.bmp)。图片区域尺寸为164*314，推片最好是区域尺寸的倍数，不然可能会被裁剪。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Welcome page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_WELCOMEFINISHPAGE_BITMAP <span style=color:#e6db74>&#34;.\resource\welcome_install.bmp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_WELCOME
</span></span></code></pre></div><blockquote><p>💁Tips: 一般在使用库时，定义其指定常量要在宏的前面，因为宏内代码会使用到其相关常量。</p></blockquote><p>效果图如下：</p><p><img src=./image/5-4.webp alt></p><h3 id=53-license界面>5.3 License界面</h3><p>一般License界面我们定义用户需要勾选确认，而不是直接点击Agree就进入下一步了。在导入Lincese界面宏之前，定义<code>MUI_LICENSEPAGE_CHECKBOX</code>常量，设定必须点击同意选项了之后才能继续进行下一步。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; License page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_LICENSEPAGE_CHECKBOX
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_LICENSE <span style=color:#e6db74>&#34;..\myapp\license.txt&#34;</span>
</span></span></code></pre></div><p>效果图如下：</p><p><img src=./image/5-5.webp alt></p><h3 id=54-组件界面>5.4 组件界面</h3><p>组件界面在实际使用中不是一个非必须的界面，在有一些可选的内容需要用户选择性安装时才需要这个界面，选择安装列表显示所有可见的Section。反之，不需要的话就移除Components page 。</p><p>组件界面的文字信息很多，我们一般定义顶部的标题(<code>MUI_PAGE_HEADER_TEXT</code>)和文本(<code>MUI_COMPONENTSPAGE_TEXT_COMPLIST</code>)，与选择框的标题文本(<code>MUI_PAGE_HEADER_SUBTEXT</code>)。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Components page</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_PAGE_HEADER_TEXT <span style=color:#e6db74>&#34;Component Selection&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_COMPONENTSPAGE_TEXT_COMPLIST <span style=color:#e6db74>&#34;Select components to install:&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_PAGE_HEADER_SUBTEXT <span style=color:#e6db74>&#34;Select the components you want to install.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_COMPONENTS
</span></span></code></pre></div><p>效果图如下：</p><p><img src=./image/5-6.webp alt></p><p>但是在实际安装包中，我们需要调整Component界面的布局。因为它默认的这个界面布局实在是利用率很低，无关信息和空白间距太多了。</p><h4 id=541-调整界面布局>5.4.1 调整界面布局</h4><p>我们可以通过NSIS提供的功能将默认的界面改变成下图的的样子：</p><p><img src=./image/5-7.webp alt></p><p>主要使用的是GDI设置方式，如果对GDI开发比较熟悉的读者将会很容易理解。下面将逐步介绍调整过程：</p><p><strong>(1) 定义界面加载函数</strong></p><p>通过GDI调整界面的布局，首先需要界面先完成显示。定义<code>MUI_PAGE_CUSTOMFUNCTION_SHOW</code>常量为一个函数<code>ComponentsPageShow</code>，我们将GDI的操作代码写入这个函数中，它将在组件界面显示后调用。</p><blockquote><p>🌟重点注意🌟：<code>MUI_PAGE_CUSTOMFUNCTION_SHOW</code>是一个MUI定义的自定义函数宏，它不特殊针对某一界面，而是在其定义后插入的第一个MUI界面宏中生效。所以，想要为一个界面设定界面显示后调用的函数，就请将这个常量定义在该界面宏的前面。同类的几个函数常量还有<code>MUI_PAGE_CUSTOMFUNCTION_PRE</code> <strong>、</strong> <code>MUI_PAGE_CUSTOMFUNCTION_LEAVE</code> <strong>、</strong> <code>MUI_PAGE_CUSTOMFUNCTION_DESTROYED</code>，详见<a href=https://nsis.sourceforge.io/Docs/Modern%20UI%202/Readme.html target=_blank>官网"Page Custom Functions"章节</a>
。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_PAGE_CUSTOMFUNCTION_SHOW ComponentsPageShow
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_COMPONENTS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; When components page show</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><blockquote><p>💡知识点一：<strong>函数</strong> 类似于区段，常用于组织可复用的安装过程。函数只能在区段中被调用，跟区段一样区分安装函数与卸载函数，不能混用。</p></blockquote><blockquote><p>💡知识点二：<strong>函数与宏的差别</strong> 宏的含义是可复用的代码片段，可以在不同的位置插入进行编译，它是编译时的。函数是运行时的，而且运行时分为安装和卸载，这两种情况下的方法不能互相调用，所以代码的复用要通过宏来实现。Updated in 2024.11</p></blockquote><p><strong>(2) 隐藏头部区域的次级文本</strong></p><p>使用<code>FindWindow</code>指令获取安装窗口的句柄，#32770 是安装程序的窗口在windows中注册的类名。</p><p>使用<code>GetDlgItem</code>指令获取指定控件的句柄，使用<code>ShowWindow</code>指令设置指定句柄控件的显示/隐藏。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Header.SubText
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Header.SubText $HWNDPARENT 1038 <span style=color:#75715e>; header area subtext</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Header.SubText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide header area subtext</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><blockquote><p>💡句柄来源：可以在NSIS安装路径下的 &ldquo;Contrib\Modern UI 2\Pages&rdquo; 中的代码文件中找到每个界面上的UI控件句柄。</p></blockquote><p>结果：</p><p><img src=./image/5-8.webp alt></p><p><strong>(3) 隐藏内容区域的主文本</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.MainText
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.MainText $0 1006 <span style=color:#75715e>; The main text of the content area</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.MainText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide the main text of the content area</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>结果：</p><p><img src=./image/5-9.webp alt></p><p><strong>(4) 隐藏安装类型选择文本和控件</strong></p><p>安装类型选择默认下没有显示，但是界面上空出了它的位置，为了避免调整UI受到干扰，我们需要将其一并隐藏。</p><blockquote><p>💡安装类型在额外进行配置了后才会出现（用的比较少），常见于驱动程序安装时选择完整安全、典型安装还是自定义安装。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.InstallationType
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.InstallationTypeText
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.InstallationTypeText $0 1021 <span style=color:#75715e>; Title text for the installation type</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.InstallationType $0 1017 <span style=color:#75715e>; installation type</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.InstallationTypeText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide header text for installation types</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.InstallationType <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide installation type</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>结果：</p><p><img src=./image/5-10.webp alt></p><p><strong>(5) 隐藏描述标题文本</strong></p><p>组件描述区域显示鼠标指向的组件列表中组件的描述文本，描述标题文本表示环绕描述文本的一个框和框上的标题文本。</p><blockquote><p>💡标题文本本质上是一个GroupBox，但是它和描述文本只是前后叠在了一起，并没有包含关系。所以，隐藏了描述文本并不影响描述文本的显示。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.DescriptionTitleText
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DescriptionTitleText $0 1042 <span style=color:#75715e>; description title text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.DescriptionTitleText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide the title text of the description</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>结果：</p><p><img src=./image/5-11.webp alt></p><p><strong>(6) 调整组件列表标题和组件列表</strong></p><p>我们将组件列表文本和组件列表移动到左上角，并调整尺寸大小。</p><p>使用NSIS自带的 System.dll 库的 Call 函数调用 Windows 系统函数 SetWindowPos 设置GDI控件的位置和尺寸。System::Call 函数的用法详见<a href=https://www.nsisfans.com/help/SectionD.3.html#D.3 target=_blank>文档</a>
，SetWindowPos 函数的用法详见<a href=https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowpos target=_blank>MSDN文档</a>
。</p><p>NSIS可以调用C标准库中的函数，语法为 [dll名]::[函数名]</p><blockquote><p>💡重点注意：SetWindowPos 从第3位参数到第6位为 x, y, cx, cy，x,y 为控件的左侧像素坐标和上侧像素坐标，相对原点为当前区域的左上角。cx,cy 为控件的像素宽高。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.ComponentListTitleText
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.ComponentList
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.ComponentListTitleText $0 1022 <span style=color:#75715e>; Component list title text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.ComponentList $0 1032 <span style=color:#75715e>; component list</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.ComponentListTitleText, i 0, i 0, i 0, i 270, i 13, i 0)&#34;</span> <span style=color:#75715e>; Sets the position of the component list title text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.ComponentList, i 0, i 0, i 18, i 270, i 176, i 0)&#34;</span> <span style=color:#75715e>; Set the position of the component list</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>结果：</p><p><img src=./image/5-12.webp alt></p><p><strong>(7) 移动磁盘占用文本和描述文本</strong></p><p>我们将组件列表文本和组件列表移动到左上角，并调整尺寸大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e># Variables</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.DescriptionText
</span></span><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.Component.DiskSizeText 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DiskSizeText $0 1023 <span style=color:#75715e>; required disk size text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DescriptionText $0 1043 <span style=color:#75715e>; The content text of the description</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.DescriptionText, i 0, i 285, i 16, i 164, i 176, i 0)&#34;</span> <span style=color:#75715e>; Sets the position of the content text of the description</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.DiskSizeText, i 0, i 0, i 210, i 0, i 0, i 1)&#34;</span> <span style=color:#75715e>; Sets the position of the disk size text</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>结果：</p><p><img src=./image/5-13.webp alt></p><h3 id=55-安装文件过程界面>5.5 安装文件过程界面</h3><p>在选择安装路径后就要进入安装文件过程，一般只配置安装过程的详细信息是否默认显示还是隐藏。<code>ShowInstDetails</code>指令设置是否显示安装文件的详细信息，详见<a href=https://www.nsisfans.com/help/Section4.8.html#4.8.1.34 target=_blank>文档</a>
。</p><blockquote><p>💡 ShowInstDetails 指令值并不表意，nevershow 实际效果为隐藏详细内容；hide 实际效果为默认收起详细内容显示，可以点击按钮展开；show 实际效果与 hide 相反。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>ShowInstDetails</span> <span style=color:#66d9ef>hide</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_INSTFILES
</span></span></code></pre></div><h3 id=56-完成界面>5.6 完成界面</h3><p>完成界面默认没有什么操作，只能点击完成结束安装程序，但更多时候我们需要在安装完成后启动我们的应用。</p><h4 id=561-用户勾选启动项>5.6.1 用户勾选启动项</h4><p>MUI 提供了两种方式实现这一目的，根据需要进行选择：</p><p><strong>(1) 方式一</strong></p><p>在完成界面宏前定义<code>MUI_FINISHPAGE_RUN</code>常量，设置完成界面需要运行的可执行程序路径。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_FINISHPAGE_RUN <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>${PRODUCT_SHORT_NAME}.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_FINISH
</span></span></code></pre></div><p>完成界面上就显示运行选项，默认为勾选状态，文本默认为常量 <code>PRODUCT_NAME</code>+<code>PRODUCT_VERSION</code>。</p><p><img src=./image/5-14.webp alt></p><p>如果想要更换显示的文本可以定义常量<code>MUI_FINISHPAGE_RUN_TEXT</code>设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_FINISHPAGE_RUN_TEXT <span style=color:#e6db74>&#34;NB My App!&#34;</span>
</span></span></code></pre></div><p><img src=./image/5-15.webp alt></p><blockquote><p>🚨 问题：这种方式是通过cmd运行的程序，默认的工作路径为cmd的程序路径。如果要运行的程序需要正确的工作路径的话，请使用方式二。</p></blockquote><p><strong>(2) 方式二</strong></p><p>定义常量<code>MUI_FINISHPAGE_RUN</code>设置空值，执行动作由常量<code>MUI_FINISHPAGE_RUN_FUNCTION</code>指定的函数来执行。在回调函数<code>FinishRun</code>中我们就可以执行任意代码，比如可以用<code>SetOutPath</code>设置正确的工作区。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_FINISHPAGE_RUN
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_FINISHPAGE_RUN_TEXT <span style=color:#e6db74>&#34;NB My App!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_FINISHPAGE_RUN_FUNCTION FinishRun
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_PAGE_FINISH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> FinishRun
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ExecShell</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>${PRODUCT_SHORT_NAME}.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><h4 id=562-后台自动启动>5.6.2 后台自动启动</h4><p>安装完成自动启动，不给用户拒绝的机会，<strong>这样的方式稍微流氓，请审慎后使用！</strong></p><p>在不定义<code>MUI_FINISHPAGE_RU</code>系列常量的情况下，我们实现函数<code>.onInstSuccess</code>，这个函数是固定命名，它将会在点击完成后运行。这样完成界面上就没有了运行选项，在每次安装完成后都会执行函数内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Function</span> .onInstSuccess
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Call</span> FinishRun
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><p>🌟<strong>回调函数</strong>🌟</p><p>NSIS的有一些内置的回调函数（或者叫生命周期函数），这些函数名称固定，只要在脚本中定义了就会在安装进行到对应时间点时被执行。回调函数分为安装回调和卸载回调，分别对应安装和卸载的过程。查看<a href=https://www.nsisfans.com/help/Section4.7.html#4.7.2 target=_blank>文档</a>
了解有哪些回调函数和他们被调用的时机。</p><h3 id=57-卸载界面>5.7 卸载界面</h3><p>卸载过程与安装过程对应，定制的方式都一致，只是需要注意定义卸载界面的常量，和卸载函数由un.开头。关于卸载界面的详细信息请参考<a href=https://nsis.sourceforge.io/Docs/Modern%20UI%202/Readme.html target=_blank>文档</a>
。</p><h1 id=6-安装组件>6. 安装组件</h1><p>一个完整的软件不仅仅包含应用程序本身，还可能包含驱动、运行时、插件、用户工具、文档等等。通常并不是所有的都一股脑让用户装上占用用户的硬盘，所以针对不同的类容要采用不同的策略进行安装。</p><ul><li>对于驱动、运行时这种作为应用程序运行基础必须安装的内容，我们将他们配置为与应用程序的安装相同的隐藏区段</li><li>对于插件、用户工具、文档等可选内容，我们可以将他们配置为常规区段。这样它们就会在组件界面上以组件的形式呈现出来。</li></ul><blockquote><p>⚠️ 注意：本章后续中的安装文件 driver、plugins 等，只是笔者为了保持<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
目录干净放置到 myapp 目录下的。其实可以在脚本中随意指定电脑上的任何路径位置，不一定非要将他们放置到需要打包的程序目录下，按照自己的实际情况和喜好来即可。</p></blockquote><p>本章代码在<a href=https://github.com/orange-pig/nsis_templates target=_blank>示例项目</a>
中对应<code>install</code>项目的installer.nsi。</p><h3 id=61-驱动和运行时的安装>6.1 驱动和运行时的安装</h3><p>驱动和运行时是高度相似内容，我们以驱动安装为例来进行描述。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>driver
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;..\myapp\driver&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; run install</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nsExec</span>::<span style=color:#a6e22e>Exec</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\driver\install.bat&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>un.driver
</span></span><span style=display:flex><span>  <span style=color:#75715e>; run uninstall</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nsExec</span>::<span style=color:#a6e22e>Exec</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\driver\uninstall.bat&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\driver&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>在代码中将<code>myapp\driver</code>中驱动安装到我们的安装目录下，在安装完成后运行安装脚本进行安装，你可以在安装脚本里编写安装命令，设置安装的参数，比如最常见的静默安装参数。</p><blockquote><p>🌟 提示：一般一个内容的安装区段与卸载区段同时编写是一个好的习惯，不要只管装不管卸载，留下垃圾遍地。不过在安装驱动或者运行时时，你可以根据自己的需要选择不编写卸载区段。</p></blockquote><p>你也可以将驱动放置到 <em><strong>$TEMP</strong></em> 临时目录下，安装完成后就将他删除。</p><p>🌟知识点🌟</p><p>这里我们用到了一个 nsis 的插件 <strong>nsExec</strong> 的函数 Exec 来执行批处理脚本。</p><p>先介绍一下 nsis 的插件系统，nsis 支持拓展插件，插件实际上是一个接口导出为 C 的动态链接库。目录在<code>C:\Program Files (x86)\NSIS\Plugins</code>下，我们可以在里面找到已经内置的插件文件，比如 <strong>nsExec</strong> 插件的dll文件 <strong>nsExec.dll</strong>。还有可以到官方论坛里找到一些你需要的三方插件下载下来，按类型放进不同的nsis的安装目录，就可以通过 <code>[插件名]::[函数名] [参数列表]</code>的方式进行调用了。更多详情请看 <a href=https://nsis.sourceforge.io/Category:Plugins target=_blank>官方文档</a>
。</p><p>除了 <code>nsExec</code> 还可以使用 <code>Exec</code> 或 <code>ExecWait</code> ，这里使用 <strong>nsExec</strong> 的原因：</p><ol><li>nsExec 是同步执行等待结果返回，Exec 是执行后不等待。</li><li>nsExec 可以静默执行，不弹出命令行窗口，ExecWait 执行要弹出命令行窗口。</li><li>nsExec 可以捕获命令行的输出并返回。</li></ol><blockquote><p>💡 自由拓展：nsExec的完整用法请看 <a href=https://nsis.sourceforge.io/NsExec_plug-in target=_blank>插件文档</a></p></blockquote><h3 id=62-插件的安装>6.2 插件的安装</h3><p>本节用 <strong>常规</strong> 和 <strong>工程化</strong> 两个层次来介绍，<strong>常规</strong> 小节包含常见博客形式的内容，<strong>工程化</strong> 小节包含实际使用时的技巧。通过对比，帮助读者认识到在互联网常见的学习内容距离实际使用的距离，而这部分基本上只能靠自己去找资料多次试错来获得。</p><h4 id=621-常规>6.2.1 常规</h4><p>我们先安装两个插件 <strong>plugin1</strong> 和 <strong>plugin2</strong>，plugin1 是一个单的dll文件，plugin2是一个插件目录。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> plugin1
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;..\myapp\plugins\plugin1.dll&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> plugin2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\plugins&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;..\myapp\plugins\plugin2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>这次在插件的名称前面没有了短横线 <code>-</code> ，它们就会出现在组件安装界面，让用户自行决定是否安装。安装效果界面如下：</p><p><img src=./image/6-1.webp alt></p><p>Section 默认情况下首选是要被安装的，我们可以通过指定 <code>/o</code> 参数默认不选。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> plugin2
</span></span></code></pre></div><p>效果：</p><p><img src=./image/6-2.webp alt></p><p>Section 默认情况下在组件选择框内是正常粗细的文字，我们可以在 Section 名称前加上 <code>!</code> 让其在界面上加粗显示。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>plugin1
</span></span></code></pre></div><p>效果：</p><p><img src=./image/6-3.webp alt></p><p>编写了安装 Section，别忘记还有卸载 Section。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>un.plugin1
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Delete</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\plugin1.dll&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> un.plugin2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;</span>$INSTDIR<span style=color:#e6db74>\plugins\plugin2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>卸载界面如下：</p><p><img src=./image/6-4.webp alt></p><p>💡 提醒：卸载界面没有进行自定义配置，配置方式与安装界面一致，只需要在下载组件界面定义前设置组件界面显示的函数，并将自定义布局的脚本放到一个宏内，这样只需要在安装和卸载两个函数中，插入这个宏就可以了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_PAGE_CUSTOMFUNCTION_SHOW un.ComponentsPageShow 
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNPAGE_COMPONENTS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; When components page show</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> RelayoutComponents
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> un.ComponentsPageShow
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> RelayoutComponents
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!macro</span> RelayoutComponents
</span></span><span style=display:flex><span>  <span style=color:#75715e>; custom components layout scripts</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!macroend</span>
</span></span></code></pre></div><p>效果图如下：</p><p><img src=./image/6-5.webp alt></p><p>一般的常规介绍类文章到这里就结束了，但是本文不会。</p><h4 id=622-工程化>6.2.2 工程化</h4><p>通过前面的常规过程我们添加了插件的安装卸载过程，但是这往往只能达到一个玩具的程度。接下来，就让我们来让插件安装变成一个可用于正式产品的环节。</p><p><strong>设置安装大小</strong></p><p>因为插件安装是用户可选的，所以有时对磁盘空间的占用就会是一个实际的问题。总所周知，很多人至今还将所有常规软件装在D盘里，而不是分盘时增加C盘的空间到200G以上。</p><p>我们通过在每个安装的 Section 中设置其安装后要实际占用的磁盘空间大小，组件界面会自动帮你计算后告诉用户。</p><p>现在 Section myapp 的开头添加它的大小，单位是 KB。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#f92672>-</span>myapp
</span></span><span style=display:flex><span>  <span style=color:#75715e>; set the section disk space requirement, unit is KB.</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 1024
</span></span></code></pre></div><p>这里我们添加的是1024KB，组件界面会就把它算上并显示出来。</p><p><img src=./image/6-6.webp alt></p><p>然后，我们在每个插件 Section 上都设置它们的大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>plugin1
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 512
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> plugin2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 512
</span></span></code></pre></div><p>在组件界面你选择对应的组件之后，就会发现占用空间的大小就会被自动累计上。</p><p><img src=./image/6-7.webp alt></p><p>同理，在卸载 Section 中设置大小，卸载界面上也会如此。但是，卸载界面的文本也是 <strong>Space required</strong>，我觉得不是很合适。修改这个文字，是支线任务，这里不做介绍了。</p><blockquote><p>建议读者可以举一反三研究一下，阅读5.4.1小节知道这个label的句柄，然后去发现nsis修改文字的命令完成修改。</p></blockquote><p><strong>添加插件的文本描述</strong></p><p>在实际安装过程中，拥有详细的文字描述可以有效帮助用户在是否安装的抉择时做出合适的判断。</p><p>这里需要先设置对应 Section 的 ID 常量名，其他逻辑内对该 Section 对应的组件选项的操作都要通过这个 ID 来进行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>plugin1 SEC_PLUGIN1_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> plugin2 SEC_PLUGIN2_ID
</span></span></code></pre></div><p>🌟 帮助理解：Section 的 ID 常量的值会在打包脚本编译时被分配为 Section 的序号值，如果你的 Section 顺序发生变化它在新做的安装包内的值就会不同，但是在一个已经制作完成的安装包内它的值不会发生改变，所以它是一个常量。</p><p>然后，加入下面的脚本内容：</p><blockquote><p>⚠️ 注意：常量的使用必须要在常量定义后，所以 Section ID 的使用代码需要编写在 Section 定义的代码后面。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>; Set components descriptions</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> DESCRIPTION_PLUGIN1 <span style=color:#e6db74>&#34;Plugin1 is a highly efficient tool designed to optimize users&#39; workflows. It offers a wide range of features, including data processing, quick analysis, and intelligent operation suggestions. Whether used in personal projects or team collaborations, Plugin1 significantly boosts productivity. With its simple and user-friendly interface, users can easily get started with minimal effort.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> DESCRIPTION_PLUGIN2 <span style=color:#e6db74>&#34;Plugin2 is dedicated to providing comprehensive multi-functional extension support, suitable for various scenarios. Its powerful modular design allows users to flexibly configure features according to their needs, enabling higher productivity and streamlined workflow management. Plugin2 combines stability with flexibility, making it the ideal choice for meeting professional demands.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_FUNCTION_DESCRIPTION_BEGIN
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_PLUGIN1_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_PLUGIN1}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_PLUGIN2_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_PLUGIN2}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_FUNCTION_DESCRIPTION_END
</span></span></code></pre></div><p>鼠标移动到组件名称上，右侧就会显示我们设置的介绍内容。效果如下：</p><p><img src=./image/6-8.webp alt></p><p>这样我们就实现了添加插件的文本描述，但是别忘了，还有卸载界面。</p><p>首先，我们来设置卸载 Section 的 ID，你应该看起来理所应当是不，那是因为你理解了 ID 的原理。</p><p>⚠️⚠️⚠️ <strong>这里有个非常需要注意的问题</strong> ⚠️⚠️⚠️</p><p>往往我们在参考网络上其他人写的脚本文件或文章内容时，经常会看到一个现象，对卸载区段的操作里使用的是安装区段的 ID。所以，一般学到这种你就会陷入困惑，要么看不懂要么理解错。</p><p>这种写法能工作的原因是因为 ID 是Section在安装包中的<strong>序号</strong>，并不是一个唯一值。很多人在编写时 安装和卸载 Section 是成对编写的，所以只设置了安装 Section 的 id，其值刚好与它对应的卸载 Section 相同。这只是一个成对出现的话刚好序号一致的巧合而已，一旦你打乱了顺序加入和不对称的 Section，这个脆弱的巧合就会马上坏掉，导致对卸载 Section 的操作出现错乱。</p><p>所以，请不要沾染黑魔法，<strong>卸载 Section 也应该单独设置 ID</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>un.plugin1 SEC_UN_PLUGIN1_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> un.plugin2 SEC_UN_PLUGIN2_ID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNFUNCTION_DESCRIPTION_BEGIN 
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_UN_PLUGIN1_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_PLUGIN1}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_UN_PLUGIN2_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_PLUGIN2}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNFUNCTION_DESCRIPTION_END
</span></span></code></pre></div><p><strong>安装状态管理</strong></p><p>如果你按照前面的操作走到这一步，一定已经发现了两个问题：</p><ol><li>安装过 plugin1 后，再次安装我根本无法知道它有没有被安装。</li><li>即使没有安装 plugin2 卸载时还是能卸载它。</li></ol><p>这个章节就是来解决这个问题：</p><p>首先，我们解决安装记录的问题。</p><p>插件安装后，我们可以记录下来它的安装状态。一般我们会将这个状态放在注册表内的软件信息下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Var</span> MyApp.InstalledPluginsCode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> .onInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Read the current installed plugins code</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ReadRegDWORD</span> $MyApp.InstalledPluginsCode <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IfErrors</span> 0 <span style=color:#f92672>+</span>2
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>StrCpy</span> $MyApp.InstalledPluginsCode 0 <span style=color:#75715e>; init to zero</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PLUGIN1_CODE 1
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> PLUGIN2_CODE 2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>plugin1 SEC_PLUGIN1_ID
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IntOp</span> $MyApp.InstalledPluginsCode $MyApp.InstalledPluginsCode <span style=color:#f92672>|</span> <span style=color:#66d9ef>${PLUGIN1_CODE}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegDWORD</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span> $MyApp.InstalledPluginsCode
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> plugin2 SEC_PLUGIN2_ID
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IntOp</span> $MyApp.InstalledPluginsCode $MyApp.InstalledPluginsCode <span style=color:#f92672>|</span> <span style=color:#66d9ef>${PLUGIN2_CODE}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegDWORD</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span> $MyApp.InstalledPluginsCode
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span></code></pre></div><p>声明变量 <strong>MyApp.InstalledPluginsCode</strong> 来记录当前的插件编码，在安装的初始化函数中读取注册表中的值 <strong>InstalledPlugins</strong>。</p><blockquote><p>💡知识点：<strong>IfErrors [有错误的跳转行数] [无错误的跳转行数]</strong> 用来判断前一条指令执行是否成功。第一个参数0代表如果未成功则执行 IfErrors 内的代码，第二个参数 +2 代表如果成功则向下数两行开始执行，因为 IfErrors 内只有一行代码，意味着跳过。</p></blockquote><blockquote><p>💡知识点：<strong>StrCpy [要设置值的变量] [值] 用来给变量赋值，虽然看名称好像是字符串Copy指令，但是实际上它可以为任何基础类型赋值。</strong></p></blockquote><p>我们用这个值来存储当前已安装的插件，这个值是一个 DWORD 值，可以认为它是一个 Int，在32位电脑上可以表示32位二进制，在64位电脑上可以表示64位二进制值。我们采用它的每一位二进制值表示一个插件，1 表示已安装，0 表示未安装。</p><p>所以，PLUGIN1_CODE 定义为 1 对应的二进制值就是 0001，PLUGIN2_CODE 定义为 2 对应的二进制值就是 0010。</p><p>我们在安装时只需要将当前安装插件的编码与已经安装的编码按位进行或计算，将计算结果写入注册表。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>IntOp</span> $MyApp.InstalledPluginsCode $MyApp.InstalledPluginsCode <span style=color:#f92672>|</span> <span style=color:#66d9ef>${PLUGIN1_CODE}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WriteRegDWORD</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span> $MyApp.InstalledPluginsCode
</span></span></code></pre></div><p>💡 知识点：<strong>IntOp</strong> 是一个数字运算计算指令，第一个参数是输出值，第二个参数是计算值1，第三个参数是操作符，第四个参数是计算值2。这里用来计算两个整型的或运算，详见 <a href=https://www.nsisfans.com/help/Section4.9.html#4.9.10.2 target=_blank>文档</a>
。</p><p>当只安装 plugin1 时注册表的值：</p><p><img src=./image/6-9.webp alt></p><p>这时，我们就可以读取出插件的安装状态，将已安装的插件标记出来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_CUSTOMFUNCTION_GUIINIT GUIInit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!macro</span> componentInstalled sectionID code <span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Push</span> $0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IntOp</span> $0 $MyApp.InstalledPluginsCode <span style=color:#960050;background-color:#1e0010>&amp;</span> <span style=color:#66d9ef>${code}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>${if}</span> $0 <span style=color:#f92672>==</span> <span style=color:#66d9ef>${code}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SectionSetFlags</span> <span style=color:#66d9ef>${sectionID}</span> 0 <span style=color:#75715e>; uncheck section</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SectionSetText</span> <span style=color:#66d9ef>${sectionID}</span> <span style=color:#e6db74>&#34;${name} (Installed)&#34;</span> <span style=color:#75715e>; append text &#39;Installed&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>${endif}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Pop</span> $0
</span></span><span style=display:flex><span><span style=color:#75715e>!macroend</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>; On UI init</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> GUIInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> componentInstalled <span style=color:#66d9ef>${SEC_PLUGIN1_ID}</span> <span style=color:#66d9ef>${PLUGIN1_CODE}</span> <span style=color:#e6db74>&#34;plugin1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> componentInstalled <span style=color:#66d9ef>${SEC_PLUGIN2_ID}</span> <span style=color:#66d9ef>${PLUGIN2_CODE}</span> <span style=color:#e6db74>&#34;plugin2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><blockquote><p>💡 提示：常量 <strong>MUI_CUSTOMFUNCTION_GUIINIT</strong> 需要定义在任何MUI的界面定义之前，不然可能会报错</p></blockquote><blockquote><p>💡 提示：常量需要在定义的代码后再使用，不然会报错找不到。</p></blockquote><p>效果如下：</p><p><img src=./image/6-10.webp alt></p><p>因为有两个插件，所以我将同样的逻辑过程实现为一个带参数的宏 <strong>componentInstalled</strong> ，通过两次调用避免编写大量重复代码。实现带参数的宏很简单，只需要在宏名称后跟上参数的名称用空格隔开即可。使用时只需要按照参数顺序依次传入值即可。</p><p>🌟 <strong>知识点：条件判断</strong> 🌟</p><p>宏 <strong>componentInstalled</strong> 内使用到了条件判断 ${if} &mldr; ${endif}，条件判断功能包含在 <code>LogicLib.nsh</code>中，详见 <a href=https://www.nsisfans.com/help/Section2.3.html#2.3.5.1 target=_blank>逻辑结构</a>
。写法如下：</p><p>a. 单分支判断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!include</span> LogicLib.nsh <span style=color:#75715e>;不包含好像也不会报错，建议加上</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${if}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${endif}</span>
</span></span></code></pre></div><p>b. 两个分支判断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>${if}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${else}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${endif}</span>
</span></span></code></pre></div><p>c. 多个分支判断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>${if}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${elseif}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${endif}</span>
</span></span></code></pre></div><p>d. 多个判断条件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>${if}</span> condition1
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>${AndIf}</span> condition2
</span></span><span style=display:flex><span>        <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${endif}</span>
</span></span></code></pre></div><p>c. 嵌套分支判断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>${if}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>${if}</span> <span style=color:#66d9ef>${Edition}</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Community&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>${elseif}</span> <span style=color:#66d9ef>${Edition}</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Business&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>${endif}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${elseif}</span> condition
</span></span><span style=display:flex><span>    <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>${endif}</span>
</span></span></code></pre></div><p><strong>然后</strong>，我们来实现卸载时检查已安装的插件。</p><p>卸载程序初始化时我们从注册表读取已安装的插件 code，在卸载界面初始化时将未安装的 section 名称设置为空值，它将不会被显示在组件列表内。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MUI_CUSTOMFUNCTION_UNGUIINIT un.UNGUIInit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> un.onInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Read the current installed plugins code</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ReadRegDWORD</span> $MyApp.InstalledPluginsCode <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IfErrors</span> 0 <span style=color:#f92672>+</span>2
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>StrCpy</span> $MyApp.InstalledPluginsCode 0 <span style=color:#75715e>; init to zero</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!macro</span> uncomponentInstalled sectionID code
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Push</span> $0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IntOp</span> $0 $MyApp.InstalledPluginsCode <span style=color:#960050;background-color:#1e0010>&amp;</span> <span style=color:#66d9ef>${code}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>${if}</span> $0 <span style=color:#f92672>!=</span> <span style=color:#66d9ef>${code}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SectionSetText</span> <span style=color:#66d9ef>${sectionID}</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>; set white name to disapear section</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>${endif}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Pop</span> $0
</span></span><span style=display:flex><span><span style=color:#75715e>!macroend</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> un.UNGUIInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> uncomponentInstalled <span style=color:#66d9ef>${SEC_UN_PLUGIN1_ID}</span> <span style=color:#66d9ef>${PLUGIN1_CODE}</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> uncomponentInstalled <span style=color:#66d9ef>${SEC_UN_PLUGIN2_ID}</span> <span style=color:#66d9ef>${PLUGIN2_CODE}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span></code></pre></div><blockquote><p>💡 提示：常量 <strong>MUI_CUSTOMFUNCTION_UNGUIINIT</strong> 需要定义在任何MUI的界面定义之前，不然可能会报错</p></blockquote><h3 id=63-工具的安装>6.3 工具的安装</h3><p>我们安装一个MySQL作为工具的示例，通过工作组将MySQL包括起来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!define</span> MYSQL_CODE   4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroup</span> <span style=color:#a6e22e>/e</span> <span style=color:#e6db74>&#34;Tools&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#e6db74>&#34;MySQL&#34;</span> SEC_MYSQL_ID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 56265
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$LocalAppdata<span style=color:#e6db74>${PRODUCT_SHORT_NAME}\mysql&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetCompress</span> <span style=color:#66d9ef>off</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>DetailPrint</span> <span style=color:#e6db74>&#34;Install MySQL...&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetDetailsPrint</span> <span style=color:#66d9ef>listonly</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;/oname=$PLUGINSDIR\mysql.7z&#34;</span> <span style=color:#e6db74>&#34;..\resource\mysql.7z&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetCompress</span> <span style=color:#66d9ef>auto</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetDetailsPrint</span> <span style=color:#66d9ef>both</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Nsis7z</span>::<span style=color:#a6e22e>ExtractWithDetails</span> <span style=color:#e6db74>&#34;</span>$PLUGINSDIR<span style=color:#e6db74>\mysql.7z&#34;</span> <span style=color:#e6db74>&#34;Installing MySQL %s...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IntOp</span> $MyApp.InstalledPluginsCode $MyApp.InstalledPluginsCode <span style=color:#f92672>|</span> <span style=color:#66d9ef>${MYSQL_CODE}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WriteRegDWORD</span> <span style=color:#66d9ef>HKLM</span> <span style=color:#e6db74>&#34;${PRODUCT_UNINSTALL_KEY}&#34;</span> <span style=color:#e6db74>&#34;InstalledPlugins&#34;</span> $MyApp.InstalledPluginsCode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Do more.. add envriment, start server, etc.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroupEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> GUIInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> componentInstalled <span style=color:#66d9ef>${SEC_MYSQL_ID}</span> <span style=color:#66d9ef>${MYSQL_CODE}</span> <span style=color:#e6db74>&#34;MySQL&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroup</span> <span style=color:#a6e22e>/e</span> <span style=color:#e6db74>&#34;un.Tools&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> un.MySQL SEC_UN_MYSQL_ID
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Do more... remove envriment, stop server, etc.</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RMDir</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;</span>$LocalAppdata<span style=color:#e6db74>${PRODUCT_SHORT_NAME}\mysql&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroupEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> un.UNGUIInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> uncomponentInstalled <span style=color:#66d9ef>${SEC_UN_MYSQL_ID}</span> <span style=color:#66d9ef>${MYSQL_CODE}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> DESCRIPTION_MYSQL <span style=color:#e6db74>&#34;This software utilizes a MySQL database to ensure reliable and efficient data management. With robust performance, scalability, and security, MySQL serves as the backbone for storing, retrieving, and processing application data, enabling seamless and stable operations.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNFUNCTION_DESCRIPTION_BEGIN 
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_UN_MYSQL_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_MYSQL}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_UNFUNCTION_DESCRIPTION_END
</span></span></code></pre></div><p>效果：</p><p><img src=./image/6-11.webp alt></p><p>代码中的 <strong>SectionGroup</strong> 和 <strong>SectionGroupEnd</strong> 围起来的 Section 将会被分到一个组中，参数 <code>/e</code> 设置默认展开改组，去掉它默认不展开该分组。</p><p>这里我们将MySQL的目录提前压缩成了 mysql.7z，这里是一个新的用法。</p><p><strong>🌟🌟</strong> <strong>一个新的用法：打包预压缩文件</strong> <strong>🌟🌟</strong></p><p>之前我们都是直接引用要安装的原始文件，但是有时我们需要安装的软件内容文件夹很多，层级很深，小文件很多，如数据库、python这种。如果直接 <code>File /r</code> 这样打入安装包存在几个问题：</p><ol><li>因为需要压缩大量文件，打包的时间稍长</li><li>压缩率不高导致安装包较大</li><li>安装时解压速度较慢</li></ol><p>这时，我们将需要安装的大量小文件提前压缩就可以极大的环节上述几个问题。</p><p>所以，代码中使用 <strong>SetCompress off</strong> 指令暂时关闭了安装包对文件的压缩，直接包含 mysql.7z。<strong>DetailPrint</strong> 指令设置安装当前 Section 过程中界面显示的文本。<strong>SetDetailsPrint listonly</strong> 指令暂时关闭安装详细输出。</p><p>因为压缩包安装时要解压，所以 <strong>File</strong> 指令使用了 <code>/oname</code> 参数指定将 mysql.7z 安装时放置到零时的插件目录下，然后再用 <strong>Nsis7z</strong> 插件将其解压。</p><p><strong>Nsis7z</strong> 插件是一个三方插件，可以从 <a href=https://nsis.sourceforge.io/Nsis7z_plug-in target=_blank>Nsis7z插件地址</a>
下载最新版 19.0.0，文档也在这个地址内，下载后将压缩包内的文件复制到NSIS的安装目录中就完成了安装。下面是示意图：</p><p><img src=./image/6-12.webp alt></p><blockquote><p>💡 笔者在网上找到 Nsis7z 目前有其他人编的 24.05 版本，速度更快，支持的文件更大，可解压压缩率更高的包。但是是未知来源无法判断安全性，所以不做推荐。</p></blockquote><h3 id=64-文档安装>6.4 文档安装</h3><p>现在我们安装的内容越来越多，组件列表也组件多起来。这种情况下，我们可以设置一些安装类型，供用户快速选择。</p><p>所以，首先我们先修改 <strong>RelayoutComponents</strong> 宏，将组件界面隐藏了的类型选择框放出来：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#75715e>!macro</span> RelayoutComponents
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FindWindow</span> $0 <span style=color:#e6db74>&#34;#32770&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> $HWNDPARENT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Header.SubText $HWNDPARENT 1038 <span style=color:#75715e>; header area subtext</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Header.SubText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide header area subtext</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.MainText $0 1006 <span style=color:#75715e>; The main text of the content area</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.MainText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide the main text of the content area</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.InstallationTypeText $0 1021 <span style=color:#75715e>; Title text for the installation type</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.InstallationType $0 1017 <span style=color:#75715e>; installation type</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.InstallationTypeText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide header text for installation types</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ShowWindow $MyApp.Component.InstallationType ${SW_HIDE} ; Hide installation type</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DescriptionTitleText $0 1042 <span style=color:#75715e>; description title text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ShowWindow</span> $MyApp.Component.DescriptionTitleText <span style=color:#66d9ef>${SW_HIDE}</span> <span style=color:#75715e>; Hide the title text of the description</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.ComponentListTitleText $0 1022 <span style=color:#75715e>; Component list title text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.ComponentList $0 1032 <span style=color:#75715e>; component list</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DiskSizeText $0 1023 <span style=color:#75715e>; required disk size text</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>GetDlgItem</span> $MyApp.Component.DescriptionText $0 1043 <span style=color:#75715e>; The content text of the description</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; # MSDN https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowpos</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.ComponentListTitleText, i 0, i 0, i 6, i 140, i 13, i 0)&#34;</span> <span style=color:#75715e>; Sets the position of the component list title text</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.ComponentList, i 0, i 0, i 24, i 270, i 176, i 0)&#34;</span> <span style=color:#75715e>; Set the position of the component list</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.DescriptionText, i 0, i 285, i 20, i 164, i 176, i 0)&#34;</span> <span style=color:#75715e>; Sets the position of the content text of the description</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.DiskSizeText, i 0, i 0, i 210, i 0, i 0, i 1)&#34;</span> <span style=color:#75715e>; Sets the position of the disk size text</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; System::Call &#34;User32::SetWindowPos(i $MyApp.Component.InstallationTypeText, i 0, i 135, i 0, i 180, i 13, i 0)&#34; </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>System</span>::<span style=color:#a6e22e>Call</span> <span style=color:#e6db74>&#34;User32::SetWindowPos(i $MyApp.Component.InstallationType, i 0, i 150, i 0, i 120, i 13, i 0)&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>!macroend</span>
</span></span></code></pre></div><p>效果如图：</p><p><img src=./image/6-13.webp alt></p><p>然后，添加文档分组：</p><blockquote><p>💡提示：这里笔者为了简化内容，就没有编写卸载，已安装判断等脚本。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>InstType</span> <span style=color:#e6db74>&#34;Typical&#34;</span> <span style=color:#75715e>; type 1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>InstType</span> <span style=color:#e6db74>&#34;Full&#34;</span>  <span style=color:#75715e>; type 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#960050;background-color:#1e0010>!</span>plugin1 SEC_PLUGIN1_ID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionIn</span> 1 2
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> plugin2 SEC_PLUGIN2_ID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionIn</span> 2
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#e6db74>&#34;MySQL&#34;</span> SEC_MYSQL_ID
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionIn</span> 1 2
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroup</span> <span style=color:#a6e22e>/e</span> <span style=color:#e6db74>&#34;Docs&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> <span style=color:#e6db74>&#34;User Manual&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionIn</span> 1 2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 12000
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$DOCUMENTS<span style=color:#e6db74>${PRODUCT_SHORT_NAME}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#e6db74>&#34;..\resource\docs\User Manual.doc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> <span style=color:#e6db74>&#34;Dec Docs&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionIn</span> 2
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AddSize</span> 25000
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOutPath</span> <span style=color:#e6db74>&#34;</span>$DOCUMENTS<span style=color:#e6db74>${PRODUCT_SHORT_NAME}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SetOverwrite</span> <span style=color:#66d9ef>ifnewer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>File</span> <span style=color:#a6e22e>/r</span> <span style=color:#e6db74>&#34;..\resource\docs\Dev Docs&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroupEnd</span>
</span></span></code></pre></div><p>通过 <strong>InstType</strong> 指令设置类型名，类型编号按照设置顺序从1开始依次排序。</p><p>通过 <strong>SectionIn</strong> 指令设置当前 Section 从属与哪个类型，可以设置多个。当选中该类型时，其对应的 Section 都会被选中。</p><h3 id=65-空安装>6.5 空安装</h3><p>有时（无用的一节）可能会遇到特殊（奇怪）的需求，需要在组件安装列表中列出一些没有实际安装内容的项。</p><p>我们通过添加一个默认补选中的空 Section，并在GUI初始化时将它设置为 <code>${SF_RO}</code> 不可用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>SectionGroup</span> <span style=color:#a6e22e>/e</span> <span style=color:#e6db74>&#34;Future&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Section</span> <span style=color:#a6e22e>/o</span> <span style=color:#e6db74>&#34;F1&#34;</span> SEC_F1_ID
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionEnd</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SectionGroupEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> GUIInit
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>;  Futures</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SectionSetFlags</span> <span style=color:#66d9ef>${SEC_F1_ID}</span> <span style=color:#66d9ef>${SF_RO}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FunctionEnd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!define</span> DESCRIPTION_F1 <span style=color:#e6db74>&#34;This component provides a powerful solution for managing user authentication and authorization with advanced security measures. It supports multiple authentication methods, including OAuth, and ensures secure data access. With customizable configurations and a user-friendly interface, it simplifies the implementation of security protocols, making it suitable for modern web and mobile applications.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_FUNCTION_DESCRIPTION_BEGIN
</span></span><span style=display:flex><span>  <span style=color:#75715e>; ...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>;  Futures</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>!insertmacro</span> MUI_DESCRIPTION_TEXT <span style=color:#66d9ef>${SEC_F1_ID}</span> <span style=color:#e6db74>&#34;${DESCRIPTION_F1}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>!insertmacro</span> MUI_FUNCTION_DESCRIPTION_END
</span></span></code></pre></div><h1 id=7-一些常用的语法和特性>7. 一些常用的语法和特性</h1><h3 id=71-代码换行>7.1 代码换行</h3><p>在 NSIS 脚本里每一行都作为一个命令处理， 如果这一行太长的话你可以使用 “\” 来分隔，编译器会自动地把下一行接到上一行来作为完整的一行，而不是看作新的行。例如:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#66d9ef>Messagebox</span> <span style=color:#66d9ef>MB_OK</span><span style=color:#f92672>|</span><span style=color:#66d9ef>MB_ICONINFORMATION</span> \
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;本示例演示了在 NSIS 脚本里如何对长的命令进行断行处理&#34;</span>
</span></span></code></pre></div><h3 id=72-字符串里需要使用双引号>7.2 字符串里需要使用双引号</h3><ol><li>字符串转义</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#e6db74>&#34;此操作将删除$&#34;</span>a.txt<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#e6db74>&#34;，本操作不可逆&#34;</span>
</span></span></code></pre></div><ol><li>使用其他字符串引号</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nsis data-lang=nsis><span style=display:flex><span><span style=color:#e6db74>&#39;此操作将删除&#34;a.txt&#34;，本操作不可逆&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span><span style=color:#e6db74>此操作将删除&#34;a.txt&#34;，本操作不可逆`</span>
</span></span></code></pre></div><p>建议使用<strong>字符串引号</strong>方式，简化代码，避免阅读不解。</p><blockquote><p>笔者注：入门内容规划的文章主题内容已基本完成，后续更新可能只是细节修改和局部内容完善。</p></blockquote></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 若烟阁</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>Me</div><div class="prose dark:prose-invert"><p>It&rsquo;s me, It&rsquo;s all.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 若烟阁</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/blog/js/grid.min.js></script><script src=/blog/js/main.min.js></script><script src=/blog/js/toc.min.js></script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>