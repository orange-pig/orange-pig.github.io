<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Flutter in Windows Desktop å·¥ç¨‹å®è·µ | è‹¥çƒŸé˜</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content='Flutterè™½ç„¶åœ¨Windowsæ¡Œé¢ç«¯å‘åŠ›ï¼Œä¹Ÿå‘å¸ƒäº†æ­£å¼ç‰ˆã€‚ä½†æ˜¯ï¼Œå…¶å¼€å‘é‡å¿ƒä»ç„¶åœ¨ç§»åŠ¨ç«¯ä¸Šã€‚å’Œå…¶ä»–æˆç†Ÿçš„æ¡Œé¢ç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼ŒFlutterè¿˜åƒä¸ªå°å­©å­ï¼Œä»è®¾è®¡ç†å¿µå’Œç¯å¢ƒç”Ÿæ€å¾ˆå¤šåœ°æ–¹éƒ½è¿˜æ˜¯ä¸€ä¸ªå°å­¦åƒ§çš„çŠ¶æ€ã€‚
æœ¬æ–‡ä¸ºç¬”è€…åœ¨Windowsæ¡Œé¢ç«¯ç¨‹åºå¼€å‘ä¸­å®é™…çš„å·¥ç¨‹åŒ–ç»éªŒæ±‡æ€»ï¼ŒåŒ…å«å•è¿›ç¨‹åº”ç”¨ã€æ‰˜ç›˜åŒ–ã€å‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®exeæ–‡ä»¶çš„åº”ç”¨ä¿¡æ¯ã€æ‰“åŒ…ä¾èµ–åº“ã€ffiã€ç¡¬ç¼–ç æ•°æ®å®‰å…¨ç­‰ç« èŠ‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚
1. å®ç°å•è¿›ç¨‹åº”ç”¨
åœ¨windowsä¸Šå•è¿›ç¨‹æˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº’æ–¥é‡(Mutex)æ¥å®ç°å•è¿›ç¨‹çš„åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºdartçš„åŸºç¡€åº“å¯¹äºwindowsçš„æ”¯æ’‘é™¤äº†ffiå‡ è¿‘äºæ— ã€‚åˆç”±äºdartæ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒç¤¾åŒºæœ‰ä¸€ä¸ªMutexåº“ï¼Œä½†æ˜¯åªæ˜¯å•çº¿ç¨‹å†…åœ¨å¼‚æ­¥åœºæ™¯ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæƒ³è¦é€šè¿‡dartæ¥å®ç°æ ‡å‡†çš„å•è¿›ç¨‹ç¨‹åºåœ¨é•¿æœŸæ¥çœ‹ä¹Ÿæ˜¯ä¸å¯èƒ½çš„äº‹æƒ…ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘Flutterçš„runnerå±‚ï¼Œå…¶ä¸­ windows\runner\win32_window.cppè¿™ä¸ªæ–‡ä»¶è´Ÿè´£å®ç°windowsçª—å£çš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ç­‰ã€‚
æˆ‘ä»¬åœ¨å…¶ä¸­Createæ–¹æ³•ä¸­åŠ å…¥ä»£ç ï¼Œå®Œæ•´å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š
#include "synchapi.h"

// others code

HANDLE hMutexHandle;
bool Win32Window::Create(const std::wstring& title,
const Point& origin,
const Size& size) {
    Destroy();

    hMutexHandle = CreateMutex(NULL, TRUE, L"mutex.my.app");

    if (hMutexHandle == NULL) {
        printf("CreateMutex error: %d\n", GetLastError());
        return false;
    }
    DWORD errorCode = GetLastError();
    if (errorCode == ERROR_INVALID_HANDLE) {
        printf("Mutex name be used.");
        return false;
    }
    else if (errorCode == ERROR_ALREADY_EXISTS) {
        printf("Mutex name already exists.");
        Destroy();

        // è¿™ä¸ªFindWindowAçš„æ–¹æ³•æœ‰ä¸ªbugï¼Œ
        // å¦‚æœæ‰“å¼€äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨çš„æ–‡ä»¶ç›®å½•å’Œåº”ç”¨åŒåï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šæ‰¾åˆ°è¿™ä¸ªèµ„æºç®¡ç†å™¨ã€‚
        // HWND handle = FindWindowA(NULL, "My App");
        
        // æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿›ç¨‹åæ¥è·å–å…¶ä¸»çª—å£çš„å¥æŸ„
        // å› ä¸ºflutteræ˜¯å•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ‰€ä»¥åªè¦è·å–çª—å£å¥æŸ„ä¸ç”¨åŒºåˆ†å°±è®¤ä¸ºæ˜¯ä¸»çª—å£
        // Get process id by process execute name
        DWORD dwProcessId = GetProcessIdByName(TEXT("PICStudio.exe"));
        if (dwProcessId == 0)
        {
            printf("Process not found!");
            return false;
        }

        // Get window handle by process id
        HWND handle = GetMainWindowHandle(dwProcessId);
        if (handle == NULL)
        {
            printf("Main window not found!");
            return false;
        }


        WINDOWPLACEMENT place = { sizeof(WINDOWPLACEMENT) };
        GetWindowPlacement(handle, &amp;place);
        switch (place.showCmd)
        {
            case SW_SHOWMAXIMIZED:
                // é”™è¯¯ç”¨æ³•ï¼šShowWindow(handle, SW_SHOWMAXIMIZED);
                SendMessage(handle, WM_SYSCOMMAND, SW_SHOWMAXIMIZED, NULL);
                break;
            case SW_SHOWMINIMIZED:
                SendMessage(handle, WM_SYSCOMMAND, SW_RESTORE, NULL);
                break;
            default:
                if (IsWindowVisible(handle))
                    SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL);
                else 
                    SendMessage(handle, WM_SYSCOMMAND, SC_RESTORE, NULL);
                break;
        }
        
        SetForegroundWindow(handle);

        return false;
    }

    // others code
}
å…¶ä¸­ï¼Œé€šè¿‡CreateMutexwin32 apiæ¥åˆ›å»ºæœ‰åç§°çš„å…¨å±€äº’æ–¥é‡ã€‚å¦‚æœäº’æ–¥é‡å·²ç»è¢«äººä½¿ç”¨äº†ï¼Œåˆ™GetLastErroræ–¹æ³•å°±ä¼šè·å–åˆ°ERROR_ALREADY_EXISTSå€¼ã€‚'><meta name=generator content="Hugo 0.151.0"><meta name=robots content="index, follow"><meta name=author content="é±¼äººå°é‡"><link rel=stylesheet href=/blog/ananke/css/main.min.efe4d852f731d5d1fbb87718387202a97aafd768cdcdaed0662bbe6982e91824.css><link rel=canonical href=https://orange-pig.github.io/blog/posts/flutter-in-windows-desktop-%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/><meta property="og:url" content="https://orange-pig.github.io/blog/posts/flutter-in-windows-desktop-%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="è‹¥çƒŸé˜"><meta property="og:title" content="Flutter in Windows Desktop å·¥ç¨‹å®è·µ"><meta property="og:description" content='Flutterè™½ç„¶åœ¨Windowsæ¡Œé¢ç«¯å‘åŠ›ï¼Œä¹Ÿå‘å¸ƒäº†æ­£å¼ç‰ˆã€‚ä½†æ˜¯ï¼Œå…¶å¼€å‘é‡å¿ƒä»ç„¶åœ¨ç§»åŠ¨ç«¯ä¸Šã€‚å’Œå…¶ä»–æˆç†Ÿçš„æ¡Œé¢ç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼ŒFlutterè¿˜åƒä¸ªå°å­©å­ï¼Œä»è®¾è®¡ç†å¿µå’Œç¯å¢ƒç”Ÿæ€å¾ˆå¤šåœ°æ–¹éƒ½è¿˜æ˜¯ä¸€ä¸ªå°å­¦åƒ§çš„çŠ¶æ€ã€‚
æœ¬æ–‡ä¸ºç¬”è€…åœ¨Windowsæ¡Œé¢ç«¯ç¨‹åºå¼€å‘ä¸­å®é™…çš„å·¥ç¨‹åŒ–ç»éªŒæ±‡æ€»ï¼ŒåŒ…å«å•è¿›ç¨‹åº”ç”¨ã€æ‰˜ç›˜åŒ–ã€å‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®exeæ–‡ä»¶çš„åº”ç”¨ä¿¡æ¯ã€æ‰“åŒ…ä¾èµ–åº“ã€ffiã€ç¡¬ç¼–ç æ•°æ®å®‰å…¨ç­‰ç« èŠ‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚
1. å®ç°å•è¿›ç¨‹åº”ç”¨ åœ¨windowsä¸Šå•è¿›ç¨‹æˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº’æ–¥é‡(Mutex)æ¥å®ç°å•è¿›ç¨‹çš„åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºdartçš„åŸºç¡€åº“å¯¹äºwindowsçš„æ”¯æ’‘é™¤äº†ffiå‡ è¿‘äºæ— ã€‚åˆç”±äºdartæ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒç¤¾åŒºæœ‰ä¸€ä¸ªMutexåº“ï¼Œä½†æ˜¯åªæ˜¯å•çº¿ç¨‹å†…åœ¨å¼‚æ­¥åœºæ™¯ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæƒ³è¦é€šè¿‡dartæ¥å®ç°æ ‡å‡†çš„å•è¿›ç¨‹ç¨‹åºåœ¨é•¿æœŸæ¥çœ‹ä¹Ÿæ˜¯ä¸å¯èƒ½çš„äº‹æƒ…ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘Flutterçš„runnerå±‚ï¼Œå…¶ä¸­ windows\runner\win32_window.cppè¿™ä¸ªæ–‡ä»¶è´Ÿè´£å®ç°windowsçª—å£çš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ç­‰ã€‚
æˆ‘ä»¬åœ¨å…¶ä¸­Createæ–¹æ³•ä¸­åŠ å…¥ä»£ç ï¼Œå®Œæ•´å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š
#include "synchapi.h" // others code HANDLE hMutexHandle; bool Win32Window::Create(const std::wstring& title, const Point& origin, const Size& size) { Destroy(); hMutexHandle = CreateMutex(NULL, TRUE, L"mutex.my.app"); if (hMutexHandle == NULL) { printf("CreateMutex error: %d\n", GetLastError()); return false; } DWORD errorCode = GetLastError(); if (errorCode == ERROR_INVALID_HANDLE) { printf("Mutex name be used."); return false; } else if (errorCode == ERROR_ALREADY_EXISTS) { printf("Mutex name already exists."); Destroy(); // è¿™ä¸ªFindWindowAçš„æ–¹æ³•æœ‰ä¸ªbugï¼Œ // å¦‚æœæ‰“å¼€äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨çš„æ–‡ä»¶ç›®å½•å’Œåº”ç”¨åŒåï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šæ‰¾åˆ°è¿™ä¸ªèµ„æºç®¡ç†å™¨ã€‚ // HWND handle = FindWindowA(NULL, "My App"); // æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿›ç¨‹åæ¥è·å–å…¶ä¸»çª—å£çš„å¥æŸ„ // å› ä¸ºflutteræ˜¯å•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ‰€ä»¥åªè¦è·å–çª—å£å¥æŸ„ä¸ç”¨åŒºåˆ†å°±è®¤ä¸ºæ˜¯ä¸»çª—å£ // Get process id by process execute name DWORD dwProcessId = GetProcessIdByName(TEXT("PICStudio.exe")); if (dwProcessId == 0) { printf("Process not found!"); return false; } // Get window handle by process id HWND handle = GetMainWindowHandle(dwProcessId); if (handle == NULL) { printf("Main window not found!"); return false; } WINDOWPLACEMENT place = { sizeof(WINDOWPLACEMENT) }; GetWindowPlacement(handle, &amp;place); switch (place.showCmd) { case SW_SHOWMAXIMIZED: // é”™è¯¯ç”¨æ³•ï¼šShowWindow(handle, SW_SHOWMAXIMIZED); SendMessage(handle, WM_SYSCOMMAND, SW_SHOWMAXIMIZED, NULL); break; case SW_SHOWMINIMIZED: SendMessage(handle, WM_SYSCOMMAND, SW_RESTORE, NULL); break; default: if (IsWindowVisible(handle)) SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL); else SendMessage(handle, WM_SYSCOMMAND, SC_RESTORE, NULL); break; } SetForegroundWindow(handle); return false; } // others code } å…¶ä¸­ï¼Œé€šè¿‡CreateMutexwin32 apiæ¥åˆ›å»ºæœ‰åç§°çš„å…¨å±€äº’æ–¥é‡ã€‚å¦‚æœäº’æ–¥é‡å·²ç»è¢«äººä½¿ç”¨äº†ï¼Œåˆ™GetLastErroræ–¹æ³•å°±ä¼šè·å–åˆ°ERROR_ALREADY_EXISTSå€¼ã€‚'><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-14T16:48:07+08:00"><meta property="article:modified_time" content="2025-10-14T16:48:07+08:00"><meta itemprop=name content="Flutter in Windows Desktop å·¥ç¨‹å®è·µ"><meta itemprop=description content='Flutterè™½ç„¶åœ¨Windowsæ¡Œé¢ç«¯å‘åŠ›ï¼Œä¹Ÿå‘å¸ƒäº†æ­£å¼ç‰ˆã€‚ä½†æ˜¯ï¼Œå…¶å¼€å‘é‡å¿ƒä»ç„¶åœ¨ç§»åŠ¨ç«¯ä¸Šã€‚å’Œå…¶ä»–æˆç†Ÿçš„æ¡Œé¢ç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼ŒFlutterè¿˜åƒä¸ªå°å­©å­ï¼Œä»è®¾è®¡ç†å¿µå’Œç¯å¢ƒç”Ÿæ€å¾ˆå¤šåœ°æ–¹éƒ½è¿˜æ˜¯ä¸€ä¸ªå°å­¦åƒ§çš„çŠ¶æ€ã€‚
æœ¬æ–‡ä¸ºç¬”è€…åœ¨Windowsæ¡Œé¢ç«¯ç¨‹åºå¼€å‘ä¸­å®é™…çš„å·¥ç¨‹åŒ–ç»éªŒæ±‡æ€»ï¼ŒåŒ…å«å•è¿›ç¨‹åº”ç”¨ã€æ‰˜ç›˜åŒ–ã€å‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®exeæ–‡ä»¶çš„åº”ç”¨ä¿¡æ¯ã€æ‰“åŒ…ä¾èµ–åº“ã€ffiã€ç¡¬ç¼–ç æ•°æ®å®‰å…¨ç­‰ç« èŠ‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚
1. å®ç°å•è¿›ç¨‹åº”ç”¨ åœ¨windowsä¸Šå•è¿›ç¨‹æˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº’æ–¥é‡(Mutex)æ¥å®ç°å•è¿›ç¨‹çš„åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºdartçš„åŸºç¡€åº“å¯¹äºwindowsçš„æ”¯æ’‘é™¤äº†ffiå‡ è¿‘äºæ— ã€‚åˆç”±äºdartæ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒç¤¾åŒºæœ‰ä¸€ä¸ªMutexåº“ï¼Œä½†æ˜¯åªæ˜¯å•çº¿ç¨‹å†…åœ¨å¼‚æ­¥åœºæ™¯ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæƒ³è¦é€šè¿‡dartæ¥å®ç°æ ‡å‡†çš„å•è¿›ç¨‹ç¨‹åºåœ¨é•¿æœŸæ¥çœ‹ä¹Ÿæ˜¯ä¸å¯èƒ½çš„äº‹æƒ…ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘Flutterçš„runnerå±‚ï¼Œå…¶ä¸­ windows\runner\win32_window.cppè¿™ä¸ªæ–‡ä»¶è´Ÿè´£å®ç°windowsçª—å£çš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ç­‰ã€‚
æˆ‘ä»¬åœ¨å…¶ä¸­Createæ–¹æ³•ä¸­åŠ å…¥ä»£ç ï¼Œå®Œæ•´å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š
#include "synchapi.h" // others code HANDLE hMutexHandle; bool Win32Window::Create(const std::wstring& title, const Point& origin, const Size& size) { Destroy(); hMutexHandle = CreateMutex(NULL, TRUE, L"mutex.my.app"); if (hMutexHandle == NULL) { printf("CreateMutex error: %d\n", GetLastError()); return false; } DWORD errorCode = GetLastError(); if (errorCode == ERROR_INVALID_HANDLE) { printf("Mutex name be used."); return false; } else if (errorCode == ERROR_ALREADY_EXISTS) { printf("Mutex name already exists."); Destroy(); // è¿™ä¸ªFindWindowAçš„æ–¹æ³•æœ‰ä¸ªbugï¼Œ // å¦‚æœæ‰“å¼€äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨çš„æ–‡ä»¶ç›®å½•å’Œåº”ç”¨åŒåï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šæ‰¾åˆ°è¿™ä¸ªèµ„æºç®¡ç†å™¨ã€‚ // HWND handle = FindWindowA(NULL, "My App"); // æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿›ç¨‹åæ¥è·å–å…¶ä¸»çª—å£çš„å¥æŸ„ // å› ä¸ºflutteræ˜¯å•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ‰€ä»¥åªè¦è·å–çª—å£å¥æŸ„ä¸ç”¨åŒºåˆ†å°±è®¤ä¸ºæ˜¯ä¸»çª—å£ // Get process id by process execute name DWORD dwProcessId = GetProcessIdByName(TEXT("PICStudio.exe")); if (dwProcessId == 0) { printf("Process not found!"); return false; } // Get window handle by process id HWND handle = GetMainWindowHandle(dwProcessId); if (handle == NULL) { printf("Main window not found!"); return false; } WINDOWPLACEMENT place = { sizeof(WINDOWPLACEMENT) }; GetWindowPlacement(handle, &amp;place); switch (place.showCmd) { case SW_SHOWMAXIMIZED: // é”™è¯¯ç”¨æ³•ï¼šShowWindow(handle, SW_SHOWMAXIMIZED); SendMessage(handle, WM_SYSCOMMAND, SW_SHOWMAXIMIZED, NULL); break; case SW_SHOWMINIMIZED: SendMessage(handle, WM_SYSCOMMAND, SW_RESTORE, NULL); break; default: if (IsWindowVisible(handle)) SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL); else SendMessage(handle, WM_SYSCOMMAND, SC_RESTORE, NULL); break; } SetForegroundWindow(handle); return false; } // others code } å…¶ä¸­ï¼Œé€šè¿‡CreateMutexwin32 apiæ¥åˆ›å»ºæœ‰åç§°çš„å…¨å±€äº’æ–¥é‡ã€‚å¦‚æœäº’æ–¥é‡å·²ç»è¢«äººä½¿ç”¨äº†ï¼Œåˆ™GetLastErroræ–¹æ³•å°±ä¼šè·å–åˆ°ERROR_ALREADY_EXISTSå€¼ã€‚'><meta itemprop=datePublished content="2025-10-14T16:48:07+08:00"><meta itemprop=dateModified content="2025-10-14T16:48:07+08:00"><meta itemprop=wordCount content="1607"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flutter in Windows Desktop å·¥ç¨‹å®è·µ"><meta name=twitter:description content='Flutterè™½ç„¶åœ¨Windowsæ¡Œé¢ç«¯å‘åŠ›ï¼Œä¹Ÿå‘å¸ƒäº†æ­£å¼ç‰ˆã€‚ä½†æ˜¯ï¼Œå…¶å¼€å‘é‡å¿ƒä»ç„¶åœ¨ç§»åŠ¨ç«¯ä¸Šã€‚å’Œå…¶ä»–æˆç†Ÿçš„æ¡Œé¢ç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼ŒFlutterè¿˜åƒä¸ªå°å­©å­ï¼Œä»è®¾è®¡ç†å¿µå’Œç¯å¢ƒç”Ÿæ€å¾ˆå¤šåœ°æ–¹éƒ½è¿˜æ˜¯ä¸€ä¸ªå°å­¦åƒ§çš„çŠ¶æ€ã€‚
æœ¬æ–‡ä¸ºç¬”è€…åœ¨Windowsæ¡Œé¢ç«¯ç¨‹åºå¼€å‘ä¸­å®é™…çš„å·¥ç¨‹åŒ–ç»éªŒæ±‡æ€»ï¼ŒåŒ…å«å•è¿›ç¨‹åº”ç”¨ã€æ‰˜ç›˜åŒ–ã€å‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®exeæ–‡ä»¶çš„åº”ç”¨ä¿¡æ¯ã€æ‰“åŒ…ä¾èµ–åº“ã€ffiã€ç¡¬ç¼–ç æ•°æ®å®‰å…¨ç­‰ç« èŠ‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚
1. å®ç°å•è¿›ç¨‹åº”ç”¨ åœ¨windowsä¸Šå•è¿›ç¨‹æˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº’æ–¥é‡(Mutex)æ¥å®ç°å•è¿›ç¨‹çš„åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºdartçš„åŸºç¡€åº“å¯¹äºwindowsçš„æ”¯æ’‘é™¤äº†ffiå‡ è¿‘äºæ— ã€‚åˆç”±äºdartæ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒç¤¾åŒºæœ‰ä¸€ä¸ªMutexåº“ï¼Œä½†æ˜¯åªæ˜¯å•çº¿ç¨‹å†…åœ¨å¼‚æ­¥åœºæ™¯ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæƒ³è¦é€šè¿‡dartæ¥å®ç°æ ‡å‡†çš„å•è¿›ç¨‹ç¨‹åºåœ¨é•¿æœŸæ¥çœ‹ä¹Ÿæ˜¯ä¸å¯èƒ½çš„äº‹æƒ…ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘Flutterçš„runnerå±‚ï¼Œå…¶ä¸­ windows\runner\win32_window.cppè¿™ä¸ªæ–‡ä»¶è´Ÿè´£å®ç°windowsçª—å£çš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ç­‰ã€‚
æˆ‘ä»¬åœ¨å…¶ä¸­Createæ–¹æ³•ä¸­åŠ å…¥ä»£ç ï¼Œå®Œæ•´å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š
#include "synchapi.h" // others code HANDLE hMutexHandle; bool Win32Window::Create(const std::wstring& title, const Point& origin, const Size& size) { Destroy(); hMutexHandle = CreateMutex(NULL, TRUE, L"mutex.my.app"); if (hMutexHandle == NULL) { printf("CreateMutex error: %d\n", GetLastError()); return false; } DWORD errorCode = GetLastError(); if (errorCode == ERROR_INVALID_HANDLE) { printf("Mutex name be used."); return false; } else if (errorCode == ERROR_ALREADY_EXISTS) { printf("Mutex name already exists."); Destroy(); // è¿™ä¸ªFindWindowAçš„æ–¹æ³•æœ‰ä¸ªbugï¼Œ // å¦‚æœæ‰“å¼€äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨çš„æ–‡ä»¶ç›®å½•å’Œåº”ç”¨åŒåï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šæ‰¾åˆ°è¿™ä¸ªèµ„æºç®¡ç†å™¨ã€‚ // HWND handle = FindWindowA(NULL, "My App"); // æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿›ç¨‹åæ¥è·å–å…¶ä¸»çª—å£çš„å¥æŸ„ // å› ä¸ºflutteræ˜¯å•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ‰€ä»¥åªè¦è·å–çª—å£å¥æŸ„ä¸ç”¨åŒºåˆ†å°±è®¤ä¸ºæ˜¯ä¸»çª—å£ // Get process id by process execute name DWORD dwProcessId = GetProcessIdByName(TEXT("PICStudio.exe")); if (dwProcessId == 0) { printf("Process not found!"); return false; } // Get window handle by process id HWND handle = GetMainWindowHandle(dwProcessId); if (handle == NULL) { printf("Main window not found!"); return false; } WINDOWPLACEMENT place = { sizeof(WINDOWPLACEMENT) }; GetWindowPlacement(handle, &amp;place); switch (place.showCmd) { case SW_SHOWMAXIMIZED: // é”™è¯¯ç”¨æ³•ï¼šShowWindow(handle, SW_SHOWMAXIMIZED); SendMessage(handle, WM_SYSCOMMAND, SW_SHOWMAXIMIZED, NULL); break; case SW_SHOWMINIMIZED: SendMessage(handle, WM_SYSCOMMAND, SW_RESTORE, NULL); break; default: if (IsWindowVisible(handle)) SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL); else SendMessage(handle, WM_SYSCOMMAND, SC_RESTORE, NULL); break; } SetForegroundWindow(handle); return false; } // others code } å…¶ä¸­ï¼Œé€šè¿‡CreateMutexwin32 apiæ¥åˆ›å»ºæœ‰åç§°çš„å…¨å±€äº’æ–¥é‡ã€‚å¦‚æœäº’æ–¥é‡å·²ç»è¢«äººä½¿ç”¨äº†ï¼Œåˆ™GetLastErroræ–¹æ³•å°±ä¼šè·å–åˆ°ERROR_ALREADY_EXISTSå€¼ã€‚'></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l center items-center justify-between"><a href=/blog/ class="f3 fw2 hover-white white-90 dib no-underline">è‹¥çƒŸé˜</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l mw8 center ph3 flex-wrap justify-between"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Posts</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Flutter in Windows Desktop å·¥ç¨‹å®è·µ</h1><p class=tracked><strong>é±¼äººå°é‡</strong></p><time class="f6 mv4 dib tracked" datetime=2025-10-14T16:48:07+08:00>October 14, 2025</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Flutterè™½ç„¶åœ¨Windowsæ¡Œé¢ç«¯å‘åŠ›ï¼Œä¹Ÿå‘å¸ƒäº†æ­£å¼ç‰ˆã€‚ä½†æ˜¯ï¼Œå…¶å¼€å‘é‡å¿ƒä»ç„¶åœ¨ç§»åŠ¨ç«¯ä¸Šã€‚å’Œå…¶ä»–æˆç†Ÿçš„æ¡Œé¢ç«¯æ¡†æ¶æ¯”èµ·æ¥ï¼ŒFlutterè¿˜åƒä¸ªå°å­©å­ï¼Œä»è®¾è®¡ç†å¿µå’Œç¯å¢ƒç”Ÿæ€å¾ˆå¤šåœ°æ–¹éƒ½è¿˜æ˜¯ä¸€ä¸ªå°å­¦åƒ§çš„çŠ¶æ€ã€‚</p><p>æœ¬æ–‡ä¸ºç¬”è€…åœ¨Windowsæ¡Œé¢ç«¯ç¨‹åºå¼€å‘ä¸­å®é™…çš„å·¥ç¨‹åŒ–ç»éªŒæ±‡æ€»ï¼ŒåŒ…å«å•è¿›ç¨‹åº”ç”¨ã€æ‰˜ç›˜åŒ–ã€å‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®exeæ–‡ä»¶çš„åº”ç”¨ä¿¡æ¯ã€æ‰“åŒ…ä¾èµ–åº“ã€ffiã€ç¡¬ç¼–ç æ•°æ®å®‰å…¨ç­‰ç« èŠ‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚</p><h2 id=1-å®ç°å•è¿›ç¨‹åº”ç”¨>1. å®ç°å•è¿›ç¨‹åº”ç”¨</h2><p>åœ¨windowsä¸Šå•è¿›ç¨‹æˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº’æ–¥é‡(Mutex)æ¥å®ç°å•è¿›ç¨‹çš„åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºdartçš„åŸºç¡€åº“å¯¹äºwindowsçš„æ”¯æ’‘é™¤äº†ffiå‡ è¿‘äºæ— ã€‚åˆç”±äºdartæ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒç¤¾åŒºæœ‰ä¸€ä¸ªMutexåº“ï¼Œä½†æ˜¯åªæ˜¯å•çº¿ç¨‹å†…åœ¨å¼‚æ­¥åœºæ™¯ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæƒ³è¦é€šè¿‡dartæ¥å®ç°æ ‡å‡†çš„å•è¿›ç¨‹ç¨‹åºåœ¨é•¿æœŸæ¥çœ‹ä¹Ÿæ˜¯ä¸å¯èƒ½çš„äº‹æƒ…ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘Flutterçš„runnerå±‚ï¼Œå…¶ä¸­ <code>windows\runner\win32_window.cpp</code>è¿™ä¸ªæ–‡ä»¶è´Ÿè´£å®ç°windowsçª—å£çš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ç­‰ã€‚</p><p>æˆ‘ä»¬åœ¨å…¶ä¸­<code>Create</code>æ–¹æ³•ä¸­åŠ å…¥ä»£ç ï¼Œå®Œæ•´å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;synchapi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// others code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>HANDLE hMutexHandle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> Win32Window<span style=color:#f92672>::</span>Create(<span style=color:#66d9ef>const</span> std<span style=color:#f92672>::</span>wstring<span style=color:#f92672>&amp;</span> title,
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> Point<span style=color:#f92672>&amp;</span> origin,
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> Size<span style=color:#f92672>&amp;</span> size) {
</span></span><span style=display:flex><span>    Destroy();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    hMutexHandle <span style=color:#f92672>=</span> CreateMutex(NULL, TRUE, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;mutex.my.app&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hMutexHandle <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;CreateMutex error: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, GetLastError());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    DWORD errorCode <span style=color:#f92672>=</span> GetLastError();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (errorCode <span style=color:#f92672>==</span> ERROR_INVALID_HANDLE) {
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;Mutex name be used.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (errorCode <span style=color:#f92672>==</span> ERROR_ALREADY_EXISTS) {
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;Mutex name already exists.&#34;</span>);
</span></span><span style=display:flex><span>        Destroy();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿™ä¸ªFindWindowAçš„æ–¹æ³•æœ‰ä¸ªbugï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// å¦‚æœæ‰“å¼€äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨çš„æ–‡ä»¶ç›®å½•å’Œåº”ç”¨åŒåï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šæ‰¾åˆ°è¿™ä¸ªèµ„æºç®¡ç†å™¨ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// HWND handle = FindWindowA(NULL, &#34;My App&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ‰€ä»¥æˆ‘ä»¬é€šè¿‡è¿›ç¨‹åæ¥è·å–å…¶ä¸»çª—å£çš„å¥æŸ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// å› ä¸ºflutteræ˜¯å•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ‰€ä»¥åªè¦è·å–çª—å£å¥æŸ„ä¸ç”¨åŒºåˆ†å°±è®¤ä¸ºæ˜¯ä¸»çª—å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Get process id by process execute name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DWORD dwProcessId <span style=color:#f92672>=</span> GetProcessIdByName(TEXT(<span style=color:#e6db74>&#34;PICStudio.exe&#34;</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (dwProcessId <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;Process not found!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Get window handle by process id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HWND handle <span style=color:#f92672>=</span> GetMainWindowHandle(dwProcessId);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (handle <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;Main window not found!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        WINDOWPLACEMENT place <span style=color:#f92672>=</span> { <span style=color:#66d9ef>sizeof</span>(WINDOWPLACEMENT) };
</span></span><span style=display:flex><span>        GetWindowPlacement(handle, <span style=color:#f92672>&amp;</span>place);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (place.showCmd)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SW_SHOWMAXIMIZED:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// é”™è¯¯ç”¨æ³•ï¼šShowWindow(handle, SW_SHOWMAXIMIZED);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                SendMessage(handle, WM_SYSCOMMAND, SW_SHOWMAXIMIZED, NULL);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SW_SHOWMINIMIZED:
</span></span><span style=display:flex><span>                SendMessage(handle, WM_SYSCOMMAND, SW_RESTORE, NULL);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (IsWindowVisible(handle))
</span></span><span style=display:flex><span>                    SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> 
</span></span><span style=display:flex><span>                    SendMessage(handle, WM_SYSCOMMAND, SC_RESTORE, NULL);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        SetForegroundWindow(handle);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// others code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œé€šè¿‡<code>CreateMutex</code>win32 apiæ¥åˆ›å»ºæœ‰åç§°çš„å…¨å±€äº’æ–¥é‡ã€‚å¦‚æœäº’æ–¥é‡å·²ç»è¢«äººä½¿ç”¨äº†ï¼Œåˆ™<code>GetLastError</code>æ–¹æ³•å°±ä¼šè·å–åˆ°<code>ERROR_ALREADY_EXISTS</code>å€¼ã€‚</p><p>äº’æ–¥é‡çš„å‘½åè¯·é‡‡ç”¨ä¸å®¹æ˜“é‡å¤çš„æ–¹å¼ï¼Œå¦‚æœå’Œå…¶ä»–çš„å…¨å±€äº‹ä»¶ã€ä¿¡å·ç¯ã€å¯ç­‰å¾…è®¡æ—¶å™¨ã€ä½œä¸šæˆ–æ–‡ä»¶æ˜ å°„å¯¹è±¡çš„åç§°ç›¸åŒï¼Œåˆ™ä¼šåˆ›å»ºå¤±è´¥ï¼Œ<code>GetLastError</code>æ–¹æ³•å°±ä¼šè·å–åˆ°<code>ERROR_INVALID_HANDLE</code>å€¼ã€‚</p><p>å†™å¥½äº’æ–¥é‡çš„é€»è¾‘åˆ¤æ–­åï¼Œå¦‚æœå‡ºç°äº’æ–¥ï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»å¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹äº†ï¼Œé‚£ä¹ˆå½“å‰è¿›ç¨‹å°±ä¸åº”è¯¥ç»§ç»­å¯åŠ¨ã€‚é€šå¸¸åšæ³•å°±æ˜¯ç›´æ¥å”¤å‡ºå·²ç»å¯åŠ¨äº†çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬é€šè¿‡<code>GetProcessIdByName</code>æ‰¾åˆ°è¿›ç¨‹å·ï¼Œé€šè¿‡<code>GetMainWindowHandle</code>æ‰¾åˆ°è¿›ç¨‹çš„ä¸»çª—å£å¥æŸ„ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯è‡ªå®šä¹‰çš„ï¼Œé™„åœ¨åé¢ã€‚ç„¶åè°ƒç”¨<code>GetWindowPlacement</code>è·å–çª—å£ä½ç½®ï¼Œ<code>SendMessage</code>å‘å·²å¯åŠ¨çš„è¿›ç¨‹çª—å£å‘é€çª—å£å‘½ä»¤çš„æ¶ˆæ¯é€šçŸ¥ï¼Œæœ€åè°ƒç”¨<code>SetForegroundWindow</code>å°†çª—å£è®¾ç½®åˆ°å‰å°ã€‚</p><p>åœ¨çª—å£è¢«éšè—ï¼ˆä¸æ˜¯æœ€å°åŒ–ï¼‰çš„æƒ…å†µä¸‹ï¼Œçª—å£çš„çŠ¶æ€ä¸ºæ­£å¸¸çŠ¶æ€ï¼Œé€šè¿‡åˆ¤æ–­çª—å£æ˜¯å¦æ˜¯Visibleçš„ï¼Œè¿›è€Œå‘é€ä¸åŒçš„æ¶ˆæ¯è®©çª—å£æ¢å¤æ˜¾ç¤ºã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (IsWindowVisible(handle))
</span></span><span style=display:flex><span>    SendMessage(handle, WM_SYSCOMMAND, SW_NORMAL, NULL);
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SendMessage</span>(handle, WM_SYSCOMMAND, SC_RESTORE, NULL);
</span></span><span style=display:flex><span><span style=color:#66d9ef>break</span>;
</span></span></code></pre></div><blockquote><p>ğŸš¨WARNING: æ˜¾ç¤ºå¦å¤–è¿›ç¨‹çª—å£è¿™é‡Œæœ‰ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œç¬”è€…ä¹Ÿæ˜¯èŠ±äº†å¤§é‡çš„æ—¶é—´æ‰¾äº†å¾ˆå¤šèµ„æ–™ã€‚ç½‘ä¸Šå¾ˆå¤šæ–‡ç« äººäº‘äº¦äº‘ï¼Œéƒ½è¯´ä½¿ç”¨ <code>ShowWindow()</code> å°±å¯ä»¥å®ç°ã€‚ä½†å®é™…ä¸Š <code>ShowWindow()</code> è¢«è®¾è®¡æ¥åœ¨å½“å‰è¿›ç¨‹ä½¿ç”¨ï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œåœ¨ç›®æ ‡çª—å£æœ€å°åŒ–çš„æƒ…å†µä¸‹æ˜¯å¯èƒ½ä¸å·¥ä½œçš„ï¼Œä½¿ç”¨ <code>SendMessage()</code> æ‰æ˜¯æ­£è§„ç¬¦åˆè®¾è®¡çš„ç”¨æ³•ã€‚</p></blockquote><p>å‚è€ƒç½‘ç«™ï¼š<a href=https://learn.microsoft.com/zh-cn/windows/win32/sync/using-mutex-objects>https://learn.microsoft.com/zh-cn/windows/win32/sync/using-mutex-objects</a></p><p>é™„ä¸Š <code>GetProcessIdByName</code> ä¸ <code>GetMainWindowHandle</code> æ–¹æ³•å®ç°ï¼Œéœ€è¦è‡ªè¡Œåœ¨<code>win32_window.h</code>å¤´æ–‡ä»¶ä¸­å®šä¹‰ç§æœ‰æ–¹æ³•ã€‚</p><p>å¤´æ–‡ä»¶ win32_window.hï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EnumContext</span> {
</span></span><span style=display:flex><span>      DWORD pid;
</span></span><span style=display:flex><span>      std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>HWND<span style=color:#f92672>&gt;</span> result;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Get process id by process execute name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  DWORD <span style=color:#a6e22e>GetProcessIdByName</span>(LPCTSTR szProcessName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Get window handle by process id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  HWND <span style=color:#a6e22e>GetMainWindowHandle</span>(DWORD dwProcessId);
</span></span></code></pre></div><p>cppæ–‡ä»¶ win32_window.cppï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>DWORD Win32Window<span style=color:#f92672>::</span>GetProcessIdByName(LPCTSTR szProcessName)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    DWORD dwProcessId <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    HANDLE hSnapshot <span style=color:#f92672>=</span> CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hSnapshot <span style=color:#f92672>==</span> INVALID_HANDLE_VALUE)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    PROCESSENTRY32 process;
</span></span><span style=display:flex><span>    process.dwSize <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(PROCESSENTRY32);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Process32First(hSnapshot, <span style=color:#f92672>&amp;</span>process))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (std<span style=color:#f92672>::</span>wstring(process.szExeFile) <span style=color:#f92672>==</span> szProcessName)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                dwProcessId <span style=color:#f92672>=</span> process.th32ProcessID;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> (Process32Next(hSnapshot, <span style=color:#f92672>&amp;</span>process));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CloseHandle(hSnapshot);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> dwProcessId;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HWND Win32Window<span style=color:#f92672>::</span>GetMainWindowHandle(DWORD processId)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>//std::vector&lt;HWND&gt; vHwnds;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    EnumContext ctx;
</span></span><span style=display:flex><span>    ctx.pid <span style=color:#f92672>=</span> processId;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æšä¸¾æ‰€æœ‰çª—å£å¥æŸ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    EnumWindows(
</span></span><span style=display:flex><span>        [](HWND hwnd, LPARAM lParam) <span style=color:#f92672>-&gt;</span> BOOL {
</span></span><span style=display:flex><span>            EnumContext<span style=color:#f92672>*</span> ctx <span style=color:#f92672>=</span> (EnumContext<span style=color:#f92672>*</span>)lParam;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            DWORD dwProcessId <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            GetWindowThreadProcessId(hwnd, <span style=color:#f92672>&amp;</span>dwProcessId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (dwProcessId <span style=color:#f92672>==</span> ctx<span style=color:#f92672>-&gt;</span>pid <span style=color:#f92672>&amp;&amp;</span> IsWindowVisible(hwnd) <span style=color:#f92672>&amp;&amp;</span> IsWindowEnabled(hwnd)) {
</span></span><span style=display:flex><span>                ctx<span style=color:#f92672>-&gt;</span>result.push_back(hwnd);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> FALSE;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        (LPARAM)<span style=color:#f92672>&amp;</span>ctx
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ctx.result.empty() <span style=color:#f92672>?</span> NULL <span style=color:#f92672>:</span> ctx.result[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=2-æ‰˜ç›˜åŒ–>2. æ‰˜ç›˜åŒ–</h2><p>æ¡Œé¢ç¨‹åºæ‰˜ç›˜åŒ–æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„å½¢æ€ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„åº“æˆ–è€…æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€å¥—æŠ€æœ¯æ–¹æ¡ˆã€‚å®ƒéœ€è¦å®ç°ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>åœ¨æ‰˜ç›˜ä¸­æ˜¾ç¤ºå›¾æ ‡ï¼Œç‚¹å‡»å¯ä»¥æ¢å¤çª—å£çŠ¶æ€</li><li>æ‰˜ç›˜å¯ä»¥å³é”®èœå•</li><li>ç‚¹å…³é—­çª—å£å¹¶ä¸å…³é—­ï¼Œè€Œæ˜¯å°†çª—å£éšè—ï¼ˆä¸æœ€å°åŒ–çš„åŒºåˆ«æ˜¯ä»»åŠ¡æ ä¸æ˜¾ç¤ºå›¾æ ‡ï¼‰</li></ul><p>å¾ˆæ˜¾ç„¶ï¼ŒFlutteræ¡†æ¶æ˜¯ä¸æ”¯æŒDesktopçš„æ‰˜ç›˜åŒ–å’Œçª—å£æ˜¾ç¤ºçŠ¶æ€çš„æ§åˆ¶ï¼Œä¸æ€ªæˆ‘å–·ä»–æ¡Œé¢è¿™å—çš„æ°´å¹³åƒä¸ªå°å­¦åƒ§ï¼Œå®Œå…¨æ‘†çƒ‚ç­‰ç¤¾åŒºè‡ªå·±åšã€‚</p><p>æ„Ÿè°¢ç¤¾åŒºå¼€å‘è€…å¼€æºäº†ä¸¤ä¸ªæ‰˜ç›˜åº“ï¼š<a href=https://pub.dev/packages/system_tray>system_tray</a> å’Œ <a href=https://pub.dev/packages/tray_manager>tray_manager</a>ï¼Œè¿™ä¸¤ä¸ªåº“æˆ‘é€‰æ‹© tray_managerï¼Œå°±å› ä¸ºå®ƒä½¿ç”¨æ–¹å¼æ›´ç®€å•ï¼Œwindowsä¸Šçš„å³é”®çš„UIæ›´ç°ä»£åŒ–ã€‚</p><p>æ„Ÿè°¢bitsdojoå¤§ä½¬åœ¨flutter desktopè¿˜æ˜¯æœªæ­£å¼å‘å¸ƒæ—¶å°±åœ¨å¸¦ç—…ä¸ºçˆ±å‘ç”µçš„ <a href=https://github.com/bitsdojo/bitsdojo_window>bitsdojo_window</a> åº“ï¼Œéƒ½è¿‡å»å¿«3å¹´äº†ã€‚å› ä¸ºæˆ‘ä»¬å†™çš„Homeç»„ä»¶åªæ˜¯ä¸€ä¸ªçª—å£å†…å®¹åŒºåŸŸï¼Œçª—å£æ˜¯ç”±runnerçš„c++è°ƒç”¨ç³»ç»Ÿapiåˆ›å»ºçš„ï¼ŒFlutterå¹¶æ²¡æœ‰æä¾›åœ¨UIå†…ç›´æ¥æ§åˆ¶å’Œè®¿é—®çª—å£çš„èƒ½åŠ›ã€‚æ‰€ä»¥è¿™ä¸ªåº“ç›´åˆ°ç°åœ¨è¿˜æ˜¯æ›¿Flutterå®˜æ–¹å¼¥è¡¥è¿™ä¸€å—ç¼ºå¤±çš„é‡è¦å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª<code>appWindow</code>å¯¹è±¡åŸºæœ¬è¦†ç›–ä½ å¯¹çª—å£å¸¸è§„èƒ½ç”¨åˆ°çš„æ‰€æœ‰ç‚¹ã€‚ä¸€èˆ¬ç”¨äºå®ç°éšè—ç³»ç»Ÿæ ‡é¢˜æ ï¼Œè‡ªå·±å®ç°æ ‡é¢˜æ ã€‚</p><h3 id=21-åˆ›å»ºæ‰˜ç›˜å›¾æ ‡>2.1. åˆ›å»ºæ‰˜ç›˜å›¾æ ‡</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºæ‰˜ç›˜å›¾æ ‡ï¼Œåªéœ€è¦åœ¨home.dartä¸­åŠ å…¥ä¸‹åˆ—ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:tray_manager/tray_manager.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_HomeState</span> <span style=color:#66d9ef>extends</span> State<span style=color:#f92672>&lt;</span>Home<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>with</span> TrayListener {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> initState() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>String</span> iconPath <span style=color:#f92672>=</span> Platform.isWindows <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;assets/images/app.ico&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;assets/images/app.png&#39;</span>;
</span></span><span style=display:flex><span>    trayManager.addListener(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    trayManager.setIcon(iconPath);   
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> dispose() {
</span></span><span style=display:flex><span>    trayManager.removeListener(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>.dispose();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨åˆå§‹åŒ–widgetçš„æ—¶å€™å¼€å¯æ‰˜ç›˜çš„ç›‘å¬å¹¶ä¸”è®¾ç½®æ‰˜ç›˜å›¾æ ‡ï¼Œåœ¨é”€æ¯widgetçš„æ—¶å€™ç§»é™¤ç›‘å¬ã€‚æ‰˜ç›˜å›¾æ ‡å¯¹äºæ‰˜ç›˜åŒ–æ˜¯å¿…è¦çš„ï¼Œè¯·åŠ¡å¿…æ·»åŠ ã€‚</p><p>å…¶æ¬¡ï¼Œå®ç°ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æ¢å¤çª—å£æ˜¾ç¤ºçŠ¶æ€ï¼Œä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:bitsdojo_window/bitsdojo_window.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_HomeState</span> <span style=color:#66d9ef>extends</span> State<span style=color:#f92672>&lt;</span>Home<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>with</span> TrayListener {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> onTrayIconMouseDown() {
</span></span><span style=display:flex><span>    appWindow.restore();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œå®ç°äº†æŠ½è±¡ç±»å‹ TrayListener çš„ <code>onTrayIconMouseDown</code>æ–¹æ³•ï¼Œå®ƒæ˜¯ tray_manager åº“æä¾›çš„4ä¸ªé¼ æ ‡å›è°ƒä¹‹ä¸€ï¼Œéƒ½æœ‰ï¼š</p><ul><li>onTrayIconMouseDown()</li><li>onTrayIconMouseUp()</li><li>onTrayIconRightMouseDown()</li><li>onTrayIconRightMouseUp()</li></ul><p>åˆ†åˆ«æ˜¯å·¦é”®æŒ‰ä¸‹æ‰˜ç›˜å›¾æ ‡ï¼Œå·¦é”®ä»æ‰˜ç›˜å›¾æ ‡ä¸Šå¼¹èµ·ï¼Œå³é”®æŒ‰ä¸‹æ‰˜ç›˜å›¾æ ‡ï¼Œå³é”®ä»æ‰˜ç›˜å›¾æ ‡ä¸Šå¼¹èµ·ã€‚ä½†æ˜¯ï¼Œç»è¿‡å®æµ‹ï¼Œä½¿ç”¨ tray_manager: 0.2.0ï¼Œä¸¤ä¸ªUpæ–¹æ³•éƒ½æœªèƒ½è¢«è§¦å‘ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ˜¯å¦è¿˜æœ‰éšå«çš„ä¿¡æ¯ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨é¼ æ ‡å·¦é”®æŒ‰ä¸‹çš„æ—¶å€™è°ƒç”¨ <code>appWindow.restore()</code>æ¢å¤çª—å£ï¼Œååˆ†ç®€å•ã€‚</p><h3 id=22-æ‰˜ç›˜å³é”®èœå•>2.2. æ‰˜ç›˜å³é”®èœå•</h3><p><code>tray_manager</code>åº“æä¾›äº†ç¾è§‚çš„æ‰˜ç›˜èœå•ï¼Œä½¿ç”¨æ–¹å¼æ˜¯å…ˆè®¾ç½®èœå•ï¼Œå†å¼¹å‡ºèœå•ã€‚ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:tray_manager/tray_manager.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_HomeState</span> <span style=color:#66d9ef>extends</span> State<span style=color:#f92672>&lt;</span>Home<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>with</span> TrayListener {
</span></span><span style=display:flex><span>  late Menu trayMenu;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> onTrayIconRightMouseDown() {
</span></span><span style=display:flex><span>    trayMenu <span style=color:#f92672>=</span> Menu(items: [
</span></span><span style=display:flex><span>      MenuItem(
</span></span><span style=display:flex><span>        label: <span style=color:#e6db74>&#39;Open&#39;</span>,
</span></span><span style=display:flex><span>        onClick: (item) <span style=color:#f92672>=&gt;</span> onTrayIconMouseDown(),
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>      MenuItem.separator(),
</span></span><span style=display:flex><span>      MenuItem(
</span></span><span style=display:flex><span>        label: <span style=color:#e6db74>&#39;Exit&#39;</span>,
</span></span><span style=display:flex><span>        onClick: (item) <span style=color:#f92672>=&gt;</span> exit(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>    trayManager.setContextMenu(trayMenu);
</span></span><span style=display:flex><span>    trayManager.popUpContextMenu();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬åœ¨ didChangeDependencies() è§¦å‘æ—¶è®¾ç½®èœå•ï¼Œè¿™ä¸ªæ—¶å€™UIå·²ç»å‡†å¤‡å¥½äº†ã€‚å®ç°äº†æŠ½è±¡ç±»å‹ TrayListener çš„<code>onTrayIconRightMouseDown</code>æ–¹æ³•ï¼Œåœ¨é¼ æ ‡å³é”®ç‚¹å‡»æ‰˜ç›˜é¼ æ ‡çš„æ—¶å€™ï¼Œå¼¹å‡ºæ‰˜ç›˜èœå•ã€‚</p><blockquote><p>ğŸš¨WARNING: å°è¯•è¿‡åœ¨initState()çš„æ—¶å€™åˆå§‹åŒ–èœå•ï¼Œç»“æœæ˜¯è°ƒç”¨äº†å¼¹å‡ºçª—å£æ— ååº”ã€‚æ›´æ–°ï¼šä½¿ç”¨ didChangeDependencies() æ—¶åˆå§‹åŒ–èœå•ï¼Œåœ¨æ›´æ–°flutteråˆ°3.10åå¤±æ•ˆï¼Œéœ€è¦åœ¨å¼¹å‡ºæ—¶è®¾ç½®èœå•ã€‚</p></blockquote><h3 id=23-ç‚¹å‡»å…³é—­çª—å£éšè—>2.3. ç‚¹å‡»å…³é—­çª—å£éšè—</h3><p>å› ä¸ºå…³é—­æŒ‰é’®åœ¨æ ‡é¢˜æ ä¸Šï¼Œå±äºç³»ç»Ÿçª—å£çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å®ƒã€‚ã€‚ã€‚ç¼–ä¸ä¸‹å»äº†ï¼Œå°±æ˜¯Flutterä¸æ”¯æŒä½ æ§åˆ¶è¿™äº›ï¼Œä½ æŠŠæ¡ä¸ä½ï¼</p><p>å…¶å®ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨runnerçš„<code>win32_window.cpp</code>ä¸­å¤„ç†çª—å£æ¶ˆæ¯å›è°ƒä¸­æ‰‹åŠ¨å¢åŠ å…³é—­æ¶ˆæ¯çš„C++ä»£ç ï¼Œå°†çª—å£è®¾ç½®ä¸ºéšè—çª—å£å°±å¯ä»¥äº†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>LRESULT Win32Window<span style=color:#f92672>::</span>MessageHandler(HWND hwnd,
</span></span><span style=display:flex><span>                            UINT <span style=color:#66d9ef>const</span> message,
</span></span><span style=display:flex><span>                            WPARAM <span style=color:#66d9ef>const</span> wparam,
</span></span><span style=display:flex><span>                            LPARAM <span style=color:#66d9ef>const</span> lparam) <span style=color:#66d9ef>noexcept</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (message) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> WM_CLOSE:
</span></span><span style=display:flex><span>        ShowWindow(hwnd, SW_HIDE);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>//case ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>DefWindowProc</span>(window_handle_, message, wparam, lparam);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=24-å¯åŠ¨ç¨‹åºä¸ºæ‰˜ç›˜>2.4. å¯åŠ¨ç¨‹åºä¸ºæ‰˜ç›˜</h3><p>å¾ˆå¤šæ¡Œé¢ç¨‹åºéƒ½æœ‰ä¸€ç§å¯åŠ¨åæ— æ„Ÿç›´æ¥æ‰˜ç›˜åŒ–çš„æ¨¡å¼ï¼ŒflutteræŒ‰ç†æ¥è¯´ä¹Ÿåº”è¯¥å®ç°è¿™æ ·ä¸€ç§èƒ½åŠ›ï¼Œä½†æ˜¯ä¸å‡ºæ„å¤–å®ƒæ²¡æœ‰ã€‚æ‰€ä»¥ï¼Œè‡ªå·±åŠ¨æ‰‹ï¼</p><blockquote><p>NOTEï¼šç¬”è€…å·²ç»å°è¯•äº†ä½¿ç”¨windowsManageråœ¨ main æ–¹æ³•é‡Œç­‰å¾…ç•Œé¢å‡†å¤‡å®Œæˆåå°†å°†å…¶éšè—ã€‚ä½†æ˜¯ç”±äºflutteræ§åˆ¶çš„æ˜¯çª—å£å†…å®¹åŒºåŸŸï¼Œéœ€è¦å…ˆæ˜¾ç¤ºçª—å£å†è¿›è¡Œæ¸²æŸ“ã€‚æ­¤æ—¶çª—å£å·²ç»å¼¹å‡ºï¼Œç„¶åå‡ºç°ç”»é¢ï¼Œç„¶åçª—å£éšè—ã€‚å¯¹äºç”¨æˆ·æ¥è¯´å°±æ˜¯çªç„¶é—ªäº†ä¸€ä¸‹ï¼Œè¿™æ ·çœ‹èµ·æ¥åƒä¸ªå¾—ç‘Ÿæäº†çš„æµæ°“è½¯ä»¶ï¼Œè¿™ç§æ–¹æ³•è¯·ä¸è¦å†å¤šåŠ å°è¯•ã€‚</p></blockquote><p>å¯åŠ¨ä¸ºæ‰˜ç›˜çš„å®ç°æ€è·¯éƒ½æ˜¯åˆ›å»ºçª—å£åå°†å…¶éšè—ï¼Œç„¶åæ ¹æ®æ¡ä»¶æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºã€‚</p><p>æ‰€ä»¥ä¸ºäº†æ”¾ç½®flutterå°†å…¶å”¤é†’ï¼Œæˆ‘ä»¬ä¿®æ”¹<code>win32_window.cpp</code>æ–‡ä»¶ä¸­çš„Showæ–¹æ³•ï¼Œè®©å…¶é»˜è®¤æ˜¾ç¤ºä¸€ä¸ªéšè—çš„çª—å£ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>bool</span> Win32Window<span style=color:#f92672>::</span>Show() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ShowWindow</span>(window_handle_, SW_HIDE);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œå†åˆ°dartçš„ main()æ–¹æ³•é‡Œæ ¹æ®æ¡ä»¶æ§åˆ¶çª—å£åˆå§‹åŒ–æ­£å¸¸æ˜¾ç¤ºæˆ–ä¸æ˜¾ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>() async {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> needTary <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>  windowManager.waitUntilReadyToShow(windowOptions, () async {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>needTary) {
</span></span><span style=display:flex><span>      await windowManager.show();
</span></span><span style=display:flex><span>      await windowManager.focus();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>ç»¼åˆèµ·æ¥ï¼Œæˆ‘ä»¬å°±å®ç°äº†çª—å£å…³é—­æ‰˜ç›˜åŒ–ï¼Œç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æ¢å¤çª—å£æ˜¾ç¤ºï¼Œå³é”®æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤ºèœå•çš„ä¸€æ•´å¥—æ‰˜ç›˜åŒ–æ–¹æ¡ˆçš„æ ¸å¿ƒå†…å®¹ã€‚å¯ä»¥ä»¥è¿™ä¸ªä¸ºåŸºç¡€æ¡†æ¶ï¼Œç»†åŒ–å®ç°è‡ªå·±çš„æ‰˜ç›˜åŠŸèƒ½ã€‚</p><h2 id=3-å‘½ä»¤è¡Œå‚æ•°>3. å‘½ä»¤è¡Œå‚æ•°</h2><p>Dartæœ¬èº«å°±æ”¯æŒmainå‡½æ•°æ¥æ”¶å‘½ä»¤è¡Œå‚æ•°ï¼Œè€Œflutteræ¡†æ¶ä¹Ÿè§£æäº†å‘½ä»¤è¡Œå‚æ•°å¹¶å°†å…¶ä¼ é€’ç»™äº†dratçš„mainå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// main.dart
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> main(List<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>String</span><span style=color:#f92672>&gt;</span> arguments) <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å‘½ä»¤è¡Œå‚æ•°<code>arguments</code>æ˜¯List å­—ç¬¦ä¸²æ•°ç»„ç±»å‹ï¼Œå’Œå…¶ä»–è¯­è¨€ç›¸åŒï¼Œä½ å¯ä»¥è‡ªå·±è§£æå‚æ•°å†…å®¹ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨è§£æçš„åº“ï¼Œæˆ‘æ¨èä½¿ç”¨è§£æåº“ <a href=https://github.com/dart-lang/args>args</a>ï¼š</p><pre tabindex=0><code>&gt; dart pub add args
</code></pre><blockquote><p>NOTE: æ ¹æ®ç¬”è€…çš„ç»éªŒï¼Œflutteråœ¨3.10å‰çš„ç‰ˆæœ¬å¯¹äºçŸ­æ¨ªçº¿å‚æ•°ï¼ˆå¦‚ï¼š<code>-l</code>ï¼‰çš„ flag ä¼šè§£ææ¼æ‰ã€‚è¿™ä¸ªé—®é¢˜åœ¨3.10æ²¡æœ‰é‡åˆ°ï¼Œå°½é‡ä½¿ç”¨æ–°ç‰ˆflutterã€‚</p></blockquote><p>é¦–å…ˆï¼Œæ„å»ºä¸€ä¸ªå‚æ•°çš„è§£æå™¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> parser <span style=color:#f92672>=</span> ArgParser()
</span></span><span style=display:flex><span>  ..addFlag(<span style=color:#e6db74>&#34;add&#34;</span>, defaultsTo: <span style=color:#66d9ef>false</span>, abbr: <span style=color:#e6db74>&#34;a&#34;</span>)
</span></span><span style=display:flex><span>  ..addFlag(<span style=color:#e6db74>&#34;delete&#34;</span>, defaultsTo: <span style=color:#66d9ef>false</span>, abbr: <span style=color:#e6db74>&#34;d&#34;</span>)
</span></span><span style=display:flex><span>  ..addFlag(<span style=color:#e6db74>&#34;query&#34;</span>, defaultsTo: <span style=color:#66d9ef>false</span>, abbr: <span style=color:#e6db74>&#34;q&#34;</span>)
</span></span><span style=display:flex><span>  ..addFlag(<span style=color:#e6db74>&#34;update&#34;</span>, defaultsTo: <span style=color:#66d9ef>false</span>, abbr: <span style=color:#e6db74>&#34;u&#34;</span>);
</span></span></code></pre></div><p>åœ¨<code>addFlag</code>çš„å‚æ•°ä¸­å®šä¹‰ä½ éœ€è¦è§£æçš„flagç±»å‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¼ å…¥å€¼æ˜¯flagçš„å®Œæ•´åç§°ï¼Œç¬¬äºŒä¸ªå€¼<code>defaultsTo</code>æ˜¯å½“æœªè§£æåˆ°æ—¶çš„é»˜è®¤å€¼ï¼Œç¬¬ä¸‰ä¸ªå€¼<code>abbr</code>æ—¶flagçš„å•å­—ç¬¦ç¼©å†™ã€‚åç§°å’Œç¼©å†™å†³å®šç€ä¼ å‚çš„å½¢å¼ï¼š</p><pre tabindex=0><code>&gt; myapp.exe --add
&gt; myapp.exe -a
</code></pre><p>å…¶ä»–çš„è¿˜æœ‰<code>addOption</code>,<code>addCommand</code>,<code>addMultiOption</code>,<code>addSeparator</code>ç­‰æ»¡è¶³æ‰€æœ‰å‚æ•°ç±»å‹çš„éœ€æ±‚ã€‚</p><p>æ¥ç€è§£æå‘½ä»¤è¡Œå‚æ•°å¾—åˆ°è§£æç»“æœï¼Œå¯¹äºflagç±»å‹çš„å‚æ•°é€šè¿‡<code>wasParsed</code>å‡½æ•°åˆ¤æ–­æ˜¯å¦æ˜¯åŒ…å«æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>ArgResults argResults <span style=color:#f92672>=</span> parser.parse(arguments);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(argResults.wasParsed(<span style=color:#e6db74>&#34;add&#34;</span>)){
</span></span><span style=display:flex><span>  <span style=color:#75715e>// do add logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=4-è®¾ç½®exeçš„åº”ç”¨ä¿¡æ¯>4. è®¾ç½®exeçš„åº”ç”¨ä¿¡æ¯</h2><p>å¯¹äºä¸€ä¸ªç”¨äºç”Ÿäº§ä½¿ç”¨çš„è½¯ä»¶äº§å“æ¥è¯´ï¼Œå®Œå–„çš„åº”ç”¨ä¿¡æ¯æ¯”ä¸å¯å°‘ï¼Œä¸€èˆ¬åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>ä¸“ä¸šçš„ç¨‹åºå›¾æ ‡</li><li>å¯æ‰§è¡Œç¨‹åºå</li><li>ç¨‹åºæ–‡ä»¶ä¿¡æ¯</li><li>è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·</li></ol><h3 id=41-è®¾ç½®å›¾æ ‡>4.1. è®¾ç½®å›¾æ ‡</h3><p>å›¾æ ‡åœ¨å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ä¸Šæ˜¾ç¤ºï¼Œåœ¨ç¨‹åºçš„æ ‡é¢˜æ ä¸Šæ˜¾ç¤ºï¼Œä¹Ÿåº”ç”¨äºåŸºäºå¯æ‰§è¡Œç¨‹åºåˆ›å»ºçš„æ¡Œé¢å’Œå¼€å§‹èœå•çš„å¿«æ·æ–¹å¼ä¸Šé™åˆ¶ï¼Œè¿˜åœ¨ä»»åŠ¡æ ä¸Šå’Œä»»åŠ¡ç®¡ç†å™¨ä¸­æ˜¾ç¤ºã€‚</p><p>åœ¨flutterä¸­è®¾ç½®å›¾æ ‡çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œå°†ä½ çš„å›¾æ ‡æ”¾ç½®åœ¨windows\runner\resourcesç›®å½•ä¸‹ã€‚ç„¶åï¼Œæ‰¾åˆ° windows\runner ä¸‹çš„<code>Runner.rc</code>æ–‡ä»¶ï¼Œæ›¿æ¢å…¶ä¸­çš„å›¾æ ‡æ–‡ä»¶åå°±å¯ä»¥äº†ã€‚</p><pre tabindex=0><code>IDI_APP_ICON            ICON                    &#34;resources\your_app.ico&#34;
</code></pre><h3 id=42-è®¾ç½®ç¨‹åºåç§°>4.2. è®¾ç½®ç¨‹åºåç§°</h3><p>é»˜è®¤æƒ…å†µä¸‹ç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œç¨‹åºåç§°ä¸é¡¹ç›®åç§°ä¸€è‡´ï¼Œå•å¾€å¾€å¾ˆå¤šæ—¶å€™é¡¹ç›®åç§°å¹¶ä¸æ˜¯æˆ‘ä»¬æœ€ç»ˆå‘å¸ƒå‡ºå»çš„äº§å“åç§°ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ä¿®æ”¹ç¼–è¯‘ç”Ÿæˆçš„ç¨‹åºåç§°ã€‚</p><p>æ‰¾åˆ° windows ç›®å½•ä¸‹çš„<code>CMakeList</code>æ–‡ä»¶ï¼Œä¿®æ”¹ä¸‹é¢è¿™è¡Œä¸­çš„nameä¸ºä½ çš„äº§å“åç§°ã€‚</p><pre tabindex=0><code>set(BINARY_NAME &#34;YourAppName&#34;)
</code></pre><h3 id=43-è®¾ç½®ç¨‹åºæ–‡ä»¶ä¿¡æ¯>4.3. è®¾ç½®ç¨‹åºæ–‡ä»¶ä¿¡æ¯</h3><p>ç¨‹åºæ–‡ä»¶ä¿¡æ¯å¯åœ¨ç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ä¸Šå³é”®ï¼ŒæŸ¥çœ‹<code>å±æ€§</code>-><code>è¯¦ç»†ä¿¡æ¯</code>ã€‚</p><p>è¿™äº›ä¿¡æ¯åœ¨ windows\runner ä¸‹çš„<code>Runner.rc</code>æ–‡ä»¶ä¸­ä¿®æ”¹å¦‚ä¸‹å­—ç¬¦å†…å®¹ã€‚</p><pre tabindex=0><code>BEGIN
    BLOCK &#34;StringFileInfo&#34;
    BEGIN
        BLOCK &#34;040904e4&#34;
        BEGIN
            VALUE &#34;CompanyName&#34;, &#34;Your Company Inc&#34; &#34;\0&#34;
            VALUE &#34;FileDescription&#34;, &#34;YourApp Descritions&#34; &#34;\0&#34;
            VALUE &#34;FileVersion&#34;, VERSION_AS_STRING &#34;\0&#34;
            VALUE &#34;InternalName&#34;, &#34;YourApp&#34; &#34;\0&#34; //invalid
            VALUE &#34;LegalCopyright&#34;, &#34;Copyright (C) 2023 Your Company Inc. All rights reserved.&#34; &#34;\0&#34;
            VALUE &#34;OriginalFilename&#34;, &#34;YourAppName.exe&#34; &#34;\0&#34; //invalid
            VALUE &#34;ProductName&#34;, &#34;Your App Name&#34; &#34;\0&#34;
            VALUE &#34;ProductVersion&#34;, VERSION_AS_STRING &#34;\0&#34;
        END
    END
    BLOCK &#34;VarFileInfo&#34;
    BEGIN
        VALUE &#34;Translation&#34;, 0x409, 1252
    END
END
</code></pre><h3 id=44-è®¾ç½®è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·>4.4. è®¾ç½®è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å·</h3><p>ä¸€ä¸ªåˆç†çš„ç‰ˆæœ¬å‘å¸ƒè¿‡ç¨‹å’Œä¸€å¥—åˆç†çš„ç‰ˆæœ¬ç¼–æ’°è§„åˆ™å¯¹äºäº§å“æŒç»­ä¿æŒæ´»åŠ›éƒ½æ˜¯ååˆ†æœ‰åˆ©çš„ï¼Œflutteræ”¯æŒ<a href=https://semver.org/>è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬</a>(2.0.0)è§„åˆ™ã€‚è®¾ç½®ç‰ˆæœ¬åœ¨<code>pubspec.yaml</code>ä¸­ä¿®æ”¹ version çš„å€¼å°±å¯ä»¥äº†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.0.0</span>-<span style=color:#ae81ff>rc1</span>
</span></span></code></pre></div><p>é»˜è®¤æƒ…å†µä¸‹ç‰ˆæœ¬å·ä¸º1.0.0+1ï¼Œ+1ä¸ºbuildå·ã€‚ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ç‰ˆæœ¬ï¼ˆFileVersioï¼‰ä¸º1.0.0.1ï¼Œäº§å“ç‰ˆæœ¬ï¼ˆProductVersionï¼‰ä¸º1.0.0+1ã€‚æ”¹ä¸º+2åˆ™æ–‡ä»¶ç‰ˆæœ¬ä¸º1.0.0.2ï¼Œäº§å“ç‰ˆæœ¬ä¸º1.0.0+2ã€‚</p><p>åŒæ—¶ï¼Œå®ƒä¹Ÿæ”¯æŒé¢„å‘å¸ƒç‰ˆï¼Œç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ç‰ˆæœ¬ä¸º1.0.0.0ï¼Œäº§å“ç‰ˆæœ¬ä¸º1.0.0-rc1ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.0.0</span>-<span style=color:#ae81ff>rc1</span>
</span></span></code></pre></div><p>ä¸Šè¿°è§„åˆ™ä¹Ÿå¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ç‰ˆæœ¬ä¸º1.0.0.1ï¼Œäº§å“ç‰ˆæœ¬ä¸º1.0.0-rc1+1ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.0.0</span>-<span style=color:#ae81ff>rc1+1</span>
</span></span></code></pre></div><h2 id=5-æ‰“åŒ…ä¾èµ–åº“>5. æ‰“åŒ…ä¾èµ–åº“</h2><p>ä¸€ä¸ªå¤æ‚çš„åº”ç”¨ç¨‹åºä¸€èˆ¬éƒ½ä¼šåŒ…å«ä¸€äº›æ–‡æ¡£ã€å›¾ç‰‡ã€åº“æ–‡ä»¶ã€å­—ä½“ç­‰èµ„æºæ–‡ä»¶ï¼Œå…¶ä¸­ç‰¹åˆ«æ˜¯å°†å¤–éƒ¨çš„ä¾èµ–åº“äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.dll .soï¼‰ä½œä¸ºæœ¬åœ°èµ„æºæ–‡ä»¶éœ€è¦ç¼–è¯‘åˆ°ç¨‹åºåŒ…ä¸­ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶è¿›è¡Œè°ƒç”¨ã€‚</p><p>flutteræä¾›äº†èµ„æºæ–‡ä»¶çš„é…ç½®æ–¹å¼ï¼Œåœ¨<code>pubspec.yaml</code>æ–‡ä»¶ä¸­é…ç½®ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>flutter</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>assets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>assets/images/</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>lib/native/win/libA.dll</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>lib/native/linux/libA.so</span>
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;docs/doc.pdf&#34;</span>
</span></span></code></pre></div><p>ç„¶åï¼Œå®ç°<code>getPlatformResourcePath</code>æ–¹æ³•æ ¹æ®assetsçš„keyè·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>getPlatformResourcePath(<span style=color:#e6db74>&#34;lib/native/win/libA.dll&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>String</span> getPlatformResourcePath(<span style=color:#66d9ef>String</span> key) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (Platform.isLinux) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> path.join(Directory.current.path, key);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (Platform.isWindows) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> assetsPath <span style=color:#f92672>=</span> path.join(Directory.current.path, <span style=color:#e6db74>&#34;data/flutter_assets&#34;</span>, key);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>File(assetsPath).existsSync()) {
</span></span><span style=display:flex><span>      assetsPath <span style=color:#f92672>=</span> path.join(Directory.current.path, key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> assetsPath;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> Exception(<span style=color:#e6db74>&#39;Unsupported platform&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><pre tabindex=0><code>flutter build windows --release
</code></pre><p>åœ¨ <code>build\windows\runner\Release</code>ä¸‹çš„<code>data\flutter_asserts\lib\native\win</code>ä¸‹å°±èƒ½æ‰¾å¾—åˆ°åº“æ–‡ä»¶äº†ã€‚</p><h2 id=6-æ¡ä»¶ç¼–è¯‘>6. æ¡ä»¶ç¼–è¯‘</h2><p>Flutterå¼€å‘æ¡†æ¶ç›®å‰è¿˜ä¸æ”¯æŒæ ¹æ®å®å‘½ä»¤è¿›è¡Œæ¡ä»¶ç¼–è¯‘ï¼Œåœ¨æ¡Œé¢å¼€å‘ç”Ÿæ€é‡Œæ— ç–‘æ˜¯ä¸€ä¸ªå¤§ç¼ºå¤±ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ä¸‰æ–¹å·¥å…·æ¥å¼¥è¡¥è¿™ä¸ªé—®é¢˜ã€‚</p><p>Definetoolå·¥å…·ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰¹é‡å®å‘½ä»¤æ›¿æ¢å·¥å…·ï¼Œå¯ä»¥å°†ä»£ç ä¸­çš„å®åŒ…æ‹¬çš„ä»£ç æŒ‰ç…§æ¡ä»¶è¿›è¡Œæ³¨é‡Šæˆ–è§£å¼€æ³¨é‡Šã€‚è¿™æ ·æˆ‘ä»¬åœ¨ç¼–è¯‘å‰è¿è¡Œä¸€ä¸‹å·¥å…·æŒ‡å®šéœ€è¦ç¼–è¯‘çš„å®ï¼Œå†è¿›è¡Œç¼–è¯‘å°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ä»£ç äº†ã€‚åŸºæœ¬ä¸Šæ”¯æŒflutteré¡¹ç›®ä¸‹çš„ç»å¤§å¤šæ•°åç¼€æ–‡ä»¶ï¼Œæ¯”å¦‚ &ldquo;.dart&rdquo;, &ldquo;.yaml&rdquo;, &ldquo;.yml&rdquo;, &ldquo;.podspec&rdquo;, &ldquo;.java&rdquo;, &ldquo;.kt&rdquo;, &ldquo;.go&rdquo;, &ldquo;.rs&rdquo;, &ldquo;.js&rdquo;, &ldquo;.ts&rdquo;, &ldquo;.php&rdquo;, &ldquo;.cs&rdquo;, &ldquo;.swift&rdquo;, &ldquo;.py&rdquo;, &ldquo;.cpp&rdquo;, &ldquo;.c&rdquo;, &ldquo;.rc&rdquo;</p><p>Definetoolå·¥å…·æ²¡æœ‰æä¾›äºŒè¿›åˆ¶releaseï¼Œéœ€è¦è‡ªè¡Œæœ¬æœºç¼–è¯‘ï¼Œå°†ç¼–è¯‘åçš„definetool.exeæ”¾å…¥flutteré¡¹ç›®æ ¹ç›®å½•ä¸‹ã€‚é“¾æ¥ï¼š<a href=https://github.com/orange-pig/definetool>orange-pig/definetool (github.com)</a></p><p>ä»£ç ç¤ºä¾‹ï¼šæ§åˆ¶widgetçš„å±æ€§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span>    Container(
</span></span><span style=display:flex><span>        decoration: <span style=color:#66d9ef>const</span> BoxDecoration(
</span></span><span style=display:flex><span>          image: DecorationImage(
</span></span><span style=display:flex><span><span style=color:#75715e>// ###ifdef DEBUG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            image: AssetImage(<span style=color:#e6db74>&#34;assets/images/a.png&#34;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ###endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ###ifdef RELEASE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/*            image: AssetImage(&#34;assets/images/b.png&#34;),
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ###endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            fit: BoxFit.fill,
</span></span><span style=display:flex><span>          ),
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>      )
</span></span></code></pre></div><p>ç„¶åæŒ‰ç…§éœ€æ±‚æ‰§è¡Œä¸‹é¢å…¶ä¸­ä¸€æ¡å‘½ä»¤å³å¯å®Œæˆç›¸åº”çš„ä»£ç åˆ‡æ¢ã€‚</p><pre tabindex=0><code>&gt; ./definetool -define DEBUG
&gt; ./definetool -define RELEASE
</code></pre><h2 id=7-ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç®€åŒ–å‘½ä»¤æ‰§è¡Œ>7. ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç®€åŒ–å‘½ä»¤æ‰§è¡Œ</h2><p>æ¨èä½¿ç”¨Rustç”Ÿæ€çš„justå·¥å…·ï¼Œè¿™æ˜¯ä¸€ä¸ªä¾¿æ·çš„æ‰§è¡Œå‘½ä»¤çš„å·¥å…·ï¼Œ<a href=https://just.systems/man/zh/>Just ç”¨æˆ·æŒ‡å—</a>ã€‚</p><p>å½“ä½ çš„ç”µè„‘ä¸Šå·²ç»å…¨å±€å®‰è£…äº†justå·¥å…·ä¹‹åï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£åœ¨ä½ çš„é¡¹ç›®ä¸­åˆ›å»º<code>.justfile</code>ã€‚æˆ‘ä»¬å°±å¯ä»¥åœ¨<code>.justfile</code>æ–‡ä»¶åè¿½åŠ å‘½ä»¤çš„é…æ–¹ã€‚</p><pre tabindex=0><code>release:
    ./definetool -define RELEASE
</code></pre><p>åœ¨å‘½ä»¤è¡Œé‡Œè¿è¡Œ <code>just release</code>å°±å¯ä»¥æ‰§è¡Œå…¶å¯¹åº”çš„å‘½ä»¤äº†ã€‚</p><p>ä¹Ÿå¯ä»¥ï¼Œä¸€ä¸ªé…æ–¹æŒ‡å®šå¤šæ¡å‘½ä»¤ï¼Œå®ƒä»¬å°†æŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p><pre tabindex=0><code>release:
    ./definetool -define RELEASE
    flutter build windows --release
</code></pre><p>è¿˜å¯ä»¥ï¼ŒæŒ‡å®šæ‰§è¡Œå…¶ä»–é…æ–¹ã€‚</p><pre tabindex=0><code>def_release:
    ./definetool -define RELEASE

release:
    just def_release
    flutter build windows --release
</code></pre><p>æˆ–è€…ï¼Œå°†å…¶ä»–é…æ–¹ä½œä¸ºå½“å‰å‘½ä»¤çš„prepareé…æ–¹ï¼Œç®€åŒ–å‘½ä»¤å®šä¹‰ã€‚prepareé…æ–¹åœ¨æ‰§è¡Œå½“å‰çš„å®é™…å‘½ä»¤å‰æ‰§è¡Œï¼Œå¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæŒ‰ç©ºæ ¼éš”å¼€ï¼Œå®ƒä»¬æŒ‰æ¬¡åºæ‰§è¡Œã€‚</p><pre tabindex=0><code>def_release:
    ./definetool -define RELEASE

def_moudleA:
    ./definetool -define MOUDLE_A

release: def_release def_moudleA
    flutter build windows --release
</code></pre><p>ç”šè‡³ï¼Œä½ è¿˜å¯ä»¥è®¾ç½®å˜é‡å’Œå‘½ä»¤å‚æ•°ã€‚</p><pre tabindex=0><code>version := `(Select-String -Pattern &#39;^version:&#39; pubspec.yaml).Line -replace &#39;^version:\s*&#39;, &#39;&#39;`
mode := &#34;Release&#34;

package:
    &amp; &#39;C:\Program Files\7-Zip\7z.exe&#39; u -tzip &#34;./build/windows/runner/Release/MyApp_{{trim(version)}}_{{mode}}.zip&#34; -r ./build/windows/runner/Release/*.*  -xr0!&#39;*.zip&#39;
    
def_release:
    ./definetool -define RELEASE

release: def_release
    flutter build windows --release

publish_release: release
    just mode=Release package
</code></pre><p>è¿™äº›åŠŸèƒ½çš„ç»„åˆï¼ŒåŸºæœ¬å°±èƒ½æ»¡è¶³å¸¸è§çš„éœ€æ±‚äº†ï¼Œæ›´å¤šçš„è¯·æŸ¥çœ‹justå·¥å…·çš„å®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹ã€‚</p><h2 id=8-æ—¥å¿—>8. æ—¥å¿—</h2><p>æ—¥å¿—è®°å½•ä½¿ç”¨ <a href=https://pub.dev/packages/logger>logger | Dart package</a> åº“ï¼Œå®ƒå¯ä»¥è¾“å‡ºæ¼‚äº®çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä¹Ÿå¯ä»¥æŒ‰æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚</p><p>åˆ›å»º my_logger.dart æ–‡ä»¶å®šä¹‰ä½ çš„loggerã€‚å…¶ä¸­çš„å®æ³¨é‡Šæ˜¯æ¡ä»¶ç¼–è¯‘ï¼Œè§ç¬¬6èŠ‚ã€‚logger åº“å·²ç»å®šä¹‰äº† Â <code>FileOuput</code>ç±»ï¼Œå¦‚æœä½ æƒ³è‡ªå·±å®šä¹‰æƒ³è¦çš„æ ¼å¼è¾“å‡ºï¼Œè¯·è‡ªå·±å®ç° <code>YourFileOuput</code>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;dart:convert&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;dart:io&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:logger/logger.dart&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:path/path.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>late Logger mylogger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> loggerInit() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> logDic <span style=color:#f92672>=</span> Directory(<span style=color:#e6db74>&#34;your_log_path&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>logDic.existsSync()) {
</span></span><span style=display:flex><span>    logDic.createSync(recursive: <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  plogger <span style=color:#f92672>=</span> Logger(
</span></span><span style=display:flex><span>    filter: ProductionFilter(),
</span></span><span style=display:flex><span>    printer: SimplePrinter(printTime: <span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    output: MultiOutput([
</span></span><span style=display:flex><span><span style=color:#75715e>// ###ifdef DEBUG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      ConsoleOutput(),
</span></span><span style=display:flex><span><span style=color:#75715e>// ###endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      MyFileOutput(file: File(join(logDic.path, <span style=color:#e6db74>&#34;p.log&#34;</span>))),
</span></span><span style=display:flex><span>    ]),
</span></span><span style=display:flex><span><span style=color:#75715e>// ###ifdef DEBUG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    level: Logger.level
</span></span><span style=display:flex><span><span style=color:#75715e>// ###endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ###ifdef RELEASE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/*      level: Level.info
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ###endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyFileOutput</span> <span style=color:#66d9ef>extends</span> LogOutput {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> File file;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>bool</span> overrideExisting;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Encoding encoding;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  late IOSink _sink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  MyFileOutput({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>this</span>.file,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.overrideExisting <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.encoding <span style=color:#f92672>=</span> utf8,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> init() {
</span></span><span style=display:flex><span>    _sink <span style=color:#f92672>=</span> file.openWrite(
</span></span><span style=display:flex><span>      mode: overrideExisting <span style=color:#f92672>?</span> FileMode.writeOnly <span style=color:#f92672>:</span> FileMode.writeOnlyAppend,
</span></span><span style=display:flex><span>      encoding: encoding,
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> output(OutputEvent event) {
</span></span><span style=display:flex><span>    _sink.writeAll(event.lines, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>);
</span></span><span style=display:flex><span>    _sink.write(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>); <span style=color:#75715e>// end of last line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>override
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> destroy() <span style=color:#66d9ef>async</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> _sink.flush();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> _sink.close();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½¿ç”¨æ–¹å¼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// åœ¨mainå‡½æ•°é‡Œåˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>loggerInit();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åœ¨éœ€è¦è®°å½•æ—¥å¿—çš„åœ°æ–¹è°ƒç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mylogger.i(<span style=color:#e6db74>&#34;****** Hello Logger ******&#34;</span>);
</span></span></code></pre></div><h2 id=9-ffiçš„ç”¨æ³•>9. FFIçš„ç”¨æ³•</h2><p>åœ¨æ¡Œé¢å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šæ¶‰åŠåˆ°å¯¹ç³»ç»Ÿ win32 apiçš„è°ƒç”¨æˆ–è€…å¯¹ä¸€äº›åŠ¨æ€é“¾æ¥åº“è¿›è¡Œè°ƒç”¨ã€‚win32 çš„è°ƒç”¨å·²ç»è¢«å°è£…æˆäº†ä¸€ä¸ªåº“ <a href=https://pub.dev/packages/win32>win32 | Dart package</a>ã€‚åŠ¨æ€é“¾æ¥åº“æˆ‘ä»¬è¿˜æ˜¯å¾—è‡ªå·±é€šè¿‡ffiè¿›è¡Œè®¿é—®ï¼Œæ•™ç¨‹ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸€äº›ç”¨æ³•ã€‚</p><p><code>å®šä¹‰å¸¸é‡</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> BLOCK_SIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;
</span></span></code></pre></div><p><code>å®šä¹‰ç»“æ„ä½“</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XXENTRY</span> <span style=color:#66d9ef>extends</span> ffi.Struct {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>ffi.UnsignedLong() <span style=color:#75715e>// ffiæä¾›äº†å¾ˆå¤šåŸºç¡€ç±»å‹ä¾›ä½ ä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  external <span style=color:#66d9ef>int</span> len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>ffi.UnsignedChar() <span style=color:#75715e>// darté‡Œå¤´åªæœ‰intï¼Œä¸ç®¡ä½ æ˜¯å•¥å­ç±»å‹ï¼Œåˆ°äº†dartéƒ½è¦å˜æˆint
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  external <span style=color:#66d9ef>int</span> count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>ffi.Array.multi([<span style=color:#ae81ff>66</span>]) <span style=color:#75715e>// å®šä¹‰æ•°ç»„ï¼Œéœ€è¦æŒ‡å®šæ•°ç»„é•¿åº¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  external ffi.Array<span style=color:#f92672>&lt;</span>ffi.UnsignedChar<span style=color:#f92672>&gt;</span> messages;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  external TIME createTime; <span style=color:#75715e>// å…¶ä»–ç»“æ„ä½“ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><code>å®šä¹‰å‡½æ•°å¯¼å‡º</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#75715e>// æ‰“å¼€åŠ¨æ€åº“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>ffi.DynamicLibrary dylib <span style=color:#f92672>=</span> ffi.DynamicLibrary.open(<span style=color:#e6db74>&#34;libraryPath&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è·å–lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> ffi.Pointer<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Function<span style=color:#f92672>&lt;</span>T <span style=color:#66d9ef>extends</span> ffi.NativeType<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>String</span> symbolName) _lookup <span style=color:#f92672>=</span> dylib.lookup;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŒ‰Cæ¥å£å®šä¹‰è·å–å¯¼å‡ºå‡½æ•°åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> _MessageBoxWPtr <span style=color:#f92672>=</span> _lookup<span style=color:#f92672>&lt;</span>ffi.NativeFunction<span style=color:#f92672>&lt;</span>ffi.Int32<span style=color:#f92672>&gt;</span> Function(ffi.IntPtr, ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Utf16<span style=color:#f92672>&gt;</span>, ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Utf16<span style=color:#f92672>&gt;</span>, ffi.Uint32)<span style=color:#f92672>&gt;</span>(<span style=color:#e6db74>&#39;MessageBoxW&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è½¬æ¢ä¸ºdartå®šä¹‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> MessageBoxW <span style=color:#f92672>=</span> _MessageBoxWPtr.asFunction<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span> Function(<span style=color:#66d9ef>int</span>, ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Utf16<span style=color:#f92672>&gt;</span>, ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Utf16<span style=color:#f92672>&gt;</span>, <span style=color:#66d9ef>int</span> uType)<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å‰ä¸¤æ­¥ä¹Ÿå¯ä»¥ç®€åŒ–ä¸ºï¼Œæ‹†å¼€æ˜¯ä¸ºäº†ç†è§£å…¶å«ä¹‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>final</span> MessageBoxW <span style=color:#f92672>=</span> user32.lookupFunction<span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>      Int32 Function(IntPtr hWnd, Pointer<span style=color:#f92672>&lt;</span>Utf16<span style=color:#f92672>&gt;</span> lpText, Pointer<span style=color:#f92672>&lt;</span>Utf16<span style=color:#f92672>&gt;</span> lpCaption, Uint32 uType),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> Function(<span style=color:#66d9ef>int</span> hWnd, Pointer<span style=color:#f92672>&lt;</span>Utf16<span style=color:#f92672>&gt;</span> lpText, Pointer<span style=color:#f92672>&lt;</span>Utf16<span style=color:#f92672>&gt;</span> lpCaption, <span style=color:#66d9ef>int</span> uType)<span style=color:#f92672>&gt;</span>(<span style=color:#e6db74>&#39;MessageBoxW&#39;</span>);
</span></span></code></pre></div><p><code>ç»“æ„ä½“çš„åˆ›å»º</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> wndClassLen <span style=color:#f92672>=</span> ffi.sizeOf<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> ffi.Pointer<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span> wndClassPtr <span style=color:#f92672>=</span> calloc.allocate<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span>(wndClassLen);
</span></span><span style=display:flex><span>wndClass.ref.style <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>wndClass.ref.lpfnWndProc <span style=color:#f92672>=</span> nullptr; <span style=color:#75715e>// ç”¨ nullptr ç®€åŒ–ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>wndClass.ref.cbClsExtra <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>wndClass.ref.cbWndExtra <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>wndClass.ref.hInstance <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>wndClass.ref.hIcon <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>wndClass.ref.hCursor <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>wndClass.ref.hbrBackground <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>wndClass.ref.lpszMenuName <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>wndClass.ref.lpszClassName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;DartWindowClass&#39;</span>.toNativeUtf16();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// free
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>calloc.free(wndClassPtr);
</span></span></code></pre></div><p><code>æŒ‡é’ˆçš„è½¬æ¢</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> wndClassLen <span style=color:#f92672>=</span> ffi.sizeOf<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> ffi.Pointer<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span> wndClassPtr <span style=color:#f92672>=</span> calloc.allocate<span style=color:#f92672>&lt;</span>WNDCLASSW<span style=color:#f92672>&gt;</span>(wndClassLen);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> wndClassPtrVoid <span style=color:#f92672>=</span> ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Void<span style=color:#f92672>&gt;</span>.fromAddress(wndClassPtr.address);
</span></span></code></pre></div><p><code>äºŒè¿›åˆ¶æ•°ç»„è½¬å­—ç¬¦ä¸²</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>String</span> castString(ffi.Array<span style=color:#f92672>&lt;</span>ffi.Char<span style=color:#f92672>&gt;</span> array) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1. read array to list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  List<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> utf8List <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>[];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>    utf8List.add(array[len]);
</span></span><span style=display:flex><span>    len<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>while</span> (len <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>&amp;&amp;</span> array[len] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  utf8List.add(<span style=color:#ae81ff>0x00</span>); <span style=color:#75715e>// add &#39;\0&#39;, end the string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2. alloc memory for string list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> Pointer<span style=color:#f92672>&lt;</span>Uint8<span style=color:#f92672>&gt;</span> ptr <span style=color:#f92672>=</span> calloc(utf8List.length);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Uint8List list <span style=color:#f92672>=</span> ptr.asTypedList(utf8List.length);
</span></span><span style=display:flex><span>  list.setAll(<span style=color:#ae81ff>0</span>, utf8List);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 3. cast utf8 pointer to string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>final</span> Pointer<span style=color:#f92672>&lt;</span>Utf8<span style=color:#f92672>&gt;</span> utf8 <span style=color:#f92672>=</span> ptr.cast<span style=color:#f92672>&lt;</span>Utf8<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>String</span> retString <span style=color:#f92672>=</span> utf8.toDartString();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  calloc.free(ptr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> retString;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>äºŒè¿›åˆ¶æ•°ç»„èµ‹å€¼</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>var</span> data <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x07</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> ffi.Pointer<span style=color:#f92672>&lt;</span>ffi.Char<span style=color:#f92672>&gt;</span> dataPointer <span style=color:#f92672>=</span> calloc.allocate<span style=color:#f92672>&lt;</span>ffi.Char<span style=color:#f92672>&gt;</span>(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> data.length; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>  dataPointer.elementAt(i).value <span style=color:#f92672>=</span> data[i];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=10-æ•°æ®å®‰å…¨>10. æ•°æ®å®‰å…¨</h2><h3 id=101-é™æ€ç¼–ç å®‰å…¨>10.1. é™æ€ç¼–ç å®‰å…¨</h3><p>åœ¨è½¯ä»¶ä¸­å¾€å¾€ä¼šå‡ºç°keyç­‰é™æ€ç¼–ç çš„å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œå¦‚æœç›´æ¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œå³ä½¿ä½ åšäº†æ··æ·†ä¹Ÿå¾ˆç®€å•å°±èƒ½è¢«æ‰¾åˆ°ã€‚æˆ‘ä»¬å¾—é€šè¿‡å¤æ‚ä¸€äº›çš„æ‰‹æ®µæ¥ä¿æŠ¤æˆ‘çš„é™æ€å­—ç¬¦ä¸²ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ <a href=https://pub.dev/packages/envied_generator>envied_generator | Dart package</a> åº“ä½¿ç”¨ç¯å¢ƒå˜é‡ç”Ÿæˆæ··æ·†åçš„å­—ç¬¦ä¸²ç¼–ç ã€‚</p><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .env æ–‡ä»¶å†™å…¥ä½ çš„é™æ€å­—ç¬¦ä¸²ï¼š</p><pre tabindex=0><code>SECURE_KEY = &#34;your_key&#34;
</code></pre><p>åœ¨ lib ç›®å½•é‡Œåˆ›å»º <code>env/env.dart</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;package:envied/envied.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>part</span> <span style=color:#e6db74>&#39;env.g.dart&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>Envied(path: <span style=color:#e6db74>&#39;.env&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Env</span> {
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>@</span>EnviedField(varName: <span style=color:#e6db74>&#39;SECURE_KEY&#39;</span>, obfuscate: <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>String</span> secureKey <span style=color:#f92672>=</span> _Env.secureKey;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ‰§è¡Œå‘½ä»¤ç”Ÿæˆ <code>env.g.dart</code>:</p><pre><code>flutter pub run build_runner build --delete-conflicting-outputs
</code></pre><p>åœ¨éœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²çš„åœ°æ–¹é€šè¿‡Envç±»ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> key <span style=color:#f92672>=</span> Env.secureKey;
</span></span></code></pre></div><p>ç¼–è¯‘æ—¶ï¼Œå¯¹ä»£ç è¿›è¡Œæ··æ·†ï¼š</p><pre><code>flutter build windows --release --obfuscate --split-debug-info=symbols
</code></pre><h3 id=102-åŠ¨æ€ä¿¡æ¯å®‰å…¨å­˜å‚¨>10.2. åŠ¨æ€ä¿¡æ¯å®‰å…¨å­˜å‚¨</h3><p>ä½¿ç”¨ <a href=https://pub.dev/packages/flutter_secure_storage>flutter_secure_storage | Flutter package</a> åº“è®¿é—®windowsçš„å®‰å…¨å­˜å‚¨åŒºï¼Œå¯ä»¥ç”¨æ¥å®‰å…¨å­˜å‚¨è¿è¡Œä¸­äº§ç”Ÿæˆ–è€…è·å¾—çš„ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dart data-lang=dart><span style=display:flex><span><span style=color:#66d9ef>final</span> secureStorage <span style=color:#f92672>=</span> FlutterSecureStorage();
</span></span><span style=display:flex><span>secureStorage.write(key: <span style=color:#e6db74>&#34;your_key&#34;</span>, value: <span style=color:#e6db74>&#34;your_secure_value&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> value <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> secureStorage.read(key: <span style=color:#e6db74>&#34;your_key&#34;</span>);
</span></span><span style=display:flex><span>secureStorage.delete(key: <span style=color:#e6db74>&#34;your_key&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// If containsKey always return true, use follow codes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>await</span> secureStorage.read(key: acc_flag) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>){
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=11-ä¸€äº›å‘ç‚¹>11. ä¸€äº›å‘ç‚¹</h2><h3 id=111-dartçš„è·¯å¾„>11.1. Dartçš„è·¯å¾„</h3><p>Dartç”±äºæ˜¯ä¸€ä¸ªè€è¯­è¨€è¢«FlutteræŒ–åŸç»™æŒ–å‡ºæ¥é‡æ–°åŠ¨æ‰‹æœ¯æ‰“æ‰®æˆäº†æ–°çš„æ ·å­ï¼Œä¼—æ‰€å‘¨çŸ¥çš„æ˜¯Dart 3 å’Œä»¥å‰å®Œå…¨æ˜¯ä¸¤ä¸ªè¯­è¨€ã€‚ä½†æ˜¯ï¼Œä¸€äº›åƒåœ¾è¿˜æ˜¯ç•™åœ¨äº†é‡Œé¢ã€‚å…¶ä¸­ä¹‹ä¸€å°±æ˜¯ï¼Œä¸è¦ç›¸ä¿¡Dartç»™ä½ çš„ä»»ä½•è·¯å¾„å­—ç¬¦ä¸²ï¼Œå®ƒåœ¨æ¯”è¾ƒé•¿çš„æƒ…å†µä¸‹ä¼šå¯¹å…¶è¿›è¡Œçœç•¥ç¼©å†™ï¼Œæ‰€ä»¥ç”¨è·¯å¾„å­—ç¬¦ä¸²æ‹¼æ¥å‰ï¼Œè¯·ä½¿ç”¨çº¯å‡€çš„è·¯å¾„ã€‚</p><p>ä¸‹é¢æä¾›äº†ä¸€ä¸ªFileSystemEntityçš„æ‹“å±•æ–¹æ³• <code>purifyPath</code>:</p><pre tabindex=0><code>extension FileSystemEntityExt on FileSystemEntity {
  String purifyPath() {
    try {
      return getLongPathName(this.absolute.path);
    } catch (error) {
      plogger.e(error);
      return this.absolute.path;
    }
  }
}

const MAX_PATH = 260;// windowsè·¯å¾„æœ€å¤§é•¿åº¦é™åˆ¶

String getLongPathName(String shortPath) {
  return using&lt;String&gt;((arena) {
    Pointer&lt;Utf16&gt; nativeValue = shortPath.toNativeUtf16();
    final buffer = wsalloc(MAX_PATH);
    final result = GetLongPathName(nativeValue, buffer, MAX_PATH);

    if (result == 0) {
      GetLastError();
      throw Exception(&#39;Failed to get LongPathName: error 0x${result.toRadixString(16)}&#39;);
    }

    return buffer.toDartString();
  });
}
</code></pre><h3 id=112-è·å–appdataè·¯å¾„>11.2. è·å–AppDataè·¯å¾„</h3><p>ç”±äº Dart çš„é‡‘ä¸» Flutter çš„æ¡Œé¢ç«¯æ˜¯ä¸€ä¸ªç§ç”Ÿå­ï¼Œæ‰€ä»¥å¾ˆå¤šæ¡Œé¢ç«¯çš„ä¸œè¥¿éƒ½æ˜¯ä¸å…¨çš„ã€‚å¦‚æœä½ æƒ³è¦è®¿é—®ç³»ç»Ÿçš„å„ç§è·¯å¾„ï¼ŒæŠ±æ­‰æ²¡æœ‰æä¾›ç›´æ¥å¯ç”¨çš„ï¼Œå¾—è‡ªå·±æƒ³åŠæ³•ã€‚</p><p>æ¯”å¦‚ï¼Œè·å–AppDataè·¯å¾„:</p><pre tabindex=0><code>// æ–¹æ³•1ï¼šä»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è·å–
final localAppData = Platform.environment[&#39;LOCALAPPDATA&#39;];

// æ–¹æ³•2ï¼šç”¨ path_provider åº“
import &#39;package:path_provider/path_provider.dart&#39;;
var tempDic = await getTemporaryDirectory();
final path = tempDic.purifyPath();// purifyPath è§ä¸Šé¢å°èŠ‚

final index = path.lastIndexOf(&#39;Temp&#39;);
appDataPath = path.substring(0, index - 1);
</code></pre><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href=https://orange-pig.github.io/blog/>&copy; è‹¥çƒŸé˜ 2025</a><div><div class=ananke-socials></div></div></div></footer></body></html>